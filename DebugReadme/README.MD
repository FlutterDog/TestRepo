Оглавление ПЗ (v0.2) — контроллер LCP (плата + схемотехника)

0. Титульные данные
0.1 Титульный лист
0.2 Лист регистрации изменений (или ссылка на журнал изменений в репозитории)
0.3 Содержание
0.4 Перечень сокращений и терминов

1. Введение
1.1 Назначение документа
1.2 Область применения контроллера LCP и состав изделия (в контексте системы)
1.3 Нормативные ссылки (ЕСКД/ГОСТ, с указанием редакций)
1.4 Дисклеймер по соответствию стандартам и приоритет первоисточников (схема/PCB/BOM)
1.5 Состав комплекта КД/файлов и структура хранения (схемы, PCB, BOM, gerber/ODB++, assembly, test)

2. Исходные данные и требования
2.1 Функциональные требования (что должен делать контроллер)
2.2 Условия эксплуатации (температура, влажность, вибрации — если задано)
2.3 Требования по питанию (номинал/диапазон, потребление, пусковые токи)
2.4 Требования по ЭМС/помехоустойчивости и защите (ESD/EFT/surge — если применимо)
2.5 Требования по ремонтопригодности и диагностике (LED, тест-точки, сервисные интерфейсы)
2.6 Требования по безопасности/изоляции (SELV, PE/шасси, зазоры/просветы — если применимо)
2.7 Требования по совместимости модулей/интерфейсов (электрические уровни, питание модулей, адресация, скорости/тайминги)

3. Общая архитектура (сверху вниз)
3.1 Структурная схема изделия (блоки и связи)
3.2 Дерево питания (power-tree)
3.3 Коммуникационные интерфейсы (RS-485/ETH/прочее) и топология
3.4 Варианты исполнения/ревизии (Rev.A/Rev.B и т. п., отличия)
3.5 Инварианты аппаратной платформы (сводно: что нельзя менять без последствий)

4. Описание электрической схемы по функциональным узлам
4.1 Вход питания и защиты (полярность, предохранение, TVS, фильтры, режимы отказа)
4.2 Стабилизаторы и опорные напряжения (номиналы, токи, причины выбора, sequencing если есть)
4.3 МК/SoC и обвязка (тактирование, reset, boot straps, watchdog, brown-out)
4.4 Память и хранение конфигурации (Flash/FRAM/EEPROM/SD — что хранится и зачем)
4.5 Интерфейсы связи
 4.5.1 RS-485 (кол-во портов, трансиверы, оконечивание, развязка, защитные цепи, земля/экран)
 4.5.2 Ethernet (PHY/MAC, разъём/магнитика, ESD, экран/шасси, требования к диф.парам)
 4.5.3 Прочие интерфейсы (USB, CAN, UART, SPI, I²C — если есть)
4.6 Дискретные/аналоговые цепи (измерения/входы/выходы — если есть)
4.7 Индикация и органы управления (LED, кнопки, buzzer — если есть)
4.8 Отладка/программирование и восстановление (SWD/JTAG/ISP, разъёмы, уровни, “anti-brick” сценарии)

5. Описание печатной платы (PCB)
5.1 Габариты, посадочные, крепёж, разъёмы (механика, ограничения корпуса)
5.2 Стек слоёв (кол-во слоёв, толщины, медь, диэлектрики — если фиксировано)
5.3 Критичные цепи и правила трассировки
 5.3.1 Обязательные правила (инварианты: возвратные токи, полигоны питания, разрывы, импеданс)
 5.3.2 Рекомендуемые правила (качество/запас: симметрия, длины, экранирование, др.)
5.4 Размещение компонентов и зонирование (тепло, noisy/sensitive зоны, вводы/ESD-зоны)
5.5 DFM/DFA: технологичность (допуски, полярности, маркировка, сборочные требования)
5.6 Тестируемость (DFT): тест-точки, контрольные измерения, минимальный набор проверок
5.7 Перечень и назначение производственных файлов (Gerber/ODB++, drill, pick&place, assembly drawing)

6. Элементная база и BOM-логика
6.1 Принципы выбора компонентов (дерейтинг, температурный диапазон, доступность)
6.2 Критичные позиции и допустимые замены (DC/DC, трансиверы, кварцы, TVS, разъёмы)
6.3 Ограничения по жизненному циклу (EOL-риск) и стратегия аналогов
6.4 Правила параметрических замен (что считать эквивалентом: ключевые параметры/корпуса/критерии)

7. Встроенные функции, влияющие на аппаратную часть (контракт HW↔FW)
7.1 Режимы загрузки/обновления (bootloader, линии boot, защита от “окирпичивания”)
7.2 Watchdog/сбросы/реакция на сбои питания (что считается аварией и что делает железо)
7.3 Аппаратно-зависимые параметры ПО (частоты, уровни, распиновка, таблицы/мапы)

8. Интерфейсы и протоколы обмена (для развития без автора)
8.1 Карта разъёмов: pinout, направление, уровни, защита, назначение
8.2 Поддерживаемые протоколы и ограничения (Modbus RTU/TCP, IEC 60870-5-104 и т. п.)
8.3 Контракт данных и структуры обмена (версии, ID устройств/каналов, совместимость; ссылки на исходники)

9. Контроль, настройка, сервис
9.1 Типовые проверки после сборки (питания, токи, осциллограммы, Ethernet/RS-485 sanity-checks)
9.2 Поиск неисправностей по симптомам (симптом → причина → проверка → действие)
9.3 Рекомендации по доработкам (что можно менять безопасно; что требует пересчёта/испытаний/ЭМС-проверок)

10. Заключение
10.1 Ключевые ограничения и инварианты (итоговый список)
10.2 Риски при изменениях и минимальный план валидации после модификации

Приложения
А. Структурная схема (рисунок)
B. Дерево питания (схема/таблица)
C. Таблица разъёмов (pinout)
D. Таблица напряжений и контрольных точек (TP map)
E. Перечень файлов проекта/релизный состав (что отдаётся в производство)
F. История ревизий платы (Rev.A → Rev.B и т. п.)
G. Карта критичных сетей/сигналов (clock/reset/boot/ETH pairs/RS-485 A-B/DC-DC SW и т. п.)
H. Снимок правил проектирования (DRC/Altium Rules) и ключевые ограничения трассировки


## 2. Исходные данные и требования

### 2.1 Функциональные требования (что должен делать контроллер)

Цель раздела: зафиксировать минимальный набор функций контроллера LCP как изделия (hardware+firmware),
чтобы:
- понимать назначение платы в системе,
- иметь критерии “работает/не работает” при сопровождении,
- не ломать ключевой функционал при развитии.

⚠️ Примечание.
Ниже — скелет требований на основе вводной (домашний/шкафной PLC, SAM3X8E, Ethernet, RS-485, SD, протоколы).
Часть пунктов требует подтверждения по фактической версии прошивки и релизной документации.

---

#### 2.1.1 Базовые функции управления

1) Контроллер выполняет функции программируемого логического устройства (PLC-класс) на базе МК ATSAM3X8E.
2) Обеспечивает выполнение прикладной логики управления, конфигурируемой пользователем через внешнюю “студию” (drag-and-drop конфигурирование).
3) Поддерживает подключение периферийных модулей ввода/вывода и внешних устройств:
   - релейные модули,
   - дискретные модули,
   - аналоговые модули,
   - устройства по RS-485 (например, газоанализаторы и др.).

⚠️ Открытый вопрос.
Нужно уточнить, какие типы модулей реально поддерживаются текущей прошивкой (LDO/LDI/LAI/LCT и т.п.) и в каком объёме.

---

#### 2.1.2 Коммуникации и обмен данными

Ethernet.
1) Контроллер обеспечивает сетевое подключение по Ethernet (через W5500).
2) Через Ethernet поддерживаются протоколы верхнего уровня (по продуктовой рамке):
   - Modbus TCP,
   - IEC 60870-5-104 (если включён в релизе).

RS-485.
3) Контроллер обеспечивает обмен по RS-485:
   - для подключения модулей (шинный обмен),
   - и/или для внешних устройств по Modbus RTU (если реализовано).

⚠️ Открытый вопрос.
Нужно подтвердить:
- режимы (server/client, master/slave) и ограничения по соединениям/скоростям,
- какой протокол используется “для модулей” (если это не Modbus).

---

#### 2.1.3 Конфигурация и хранение параметров

1) Контроллер поддерживает хранение конфигурации на microSD карте:
   - чтение конфигурационных файлов при запуске и/или по команде,
   - структура конфигурации должна быть задокументирована (см. раздел 8.3).

2) Контроллер должен сохранять критичные параметры, необходимые для запуска и связи:
   - сетевые параметры (если не DHCP),
   - параметры RS-485 (скорость/паритет/адрес),
   - конфигурацию подключенных модулей/каналов.

⚠️ Открытый вопрос.
Нужно уточнить, что является “источником истины”:
- только SD,
- SD + внутреннее хранение (Flash/EEPROM/FRAM),
- как решается вопрос “конфиг изменили на месте”.

---

#### 2.1.4 Индикация, диагностика и сервис

1) Контроллер имеет базовую индикацию состояния (LED), которая должна показывать:
   - наличие питания/работу контроллера,
   - статус SD (наличие/успех чтения),
   - статус связи (Ethernet link/activity),
   - статусы RS-485 (передача/работа портов) — если реализовано аппаратно.

2) Контроллер должен быть ремонтопригодным:
   - доступ к JTAG и NRST для прошивки/восстановления,
   - возможность измерения ключевых напряжений (+5V, +3V3),
   - минимальные сервисные проверки (см. 9.1).

⚠️ Открытый вопрос.
Нужно подтвердить перечень LED и их назначение (по схемам видно SD_OK, PLC_OK, LINKLED/ACTLED, RTS1/RTS2, но нужно закрыть таблицей).

---

#### 2.1.5 Поведение при сбоях и надёжность

1) Контроллер должен корректно запускаться после подачи питания и выдерживать штатные колебания питания шкафа.
2) При зависании ПО (если watchdog включён) контроллер должен перезапускаться автоматически.
3) Должна быть возможность восстановления устройства через сервисный интерфейс (JTAG).

⚠️ Открытый вопрос.
Нужно подтвердить фактические настройки watchdog/brown-out в релизной прошивке (раздел 7.2).

---

#### 2.1.6 Критерии приемки функционала (минимальные)

Минимальный набор “PASS” для готовой платы + прошивки:
- стабильные +5V и +3V3,
- МК стартует (нет циклического reset),
- Ethernet: линк + базовый обмен,
- RS-485: базовый обмен с модулем/устройством,
- SD: детект/чтение конфигурации (если используется),
- LED индикация соответствует состояниям.

ℹ️ Детальные сценарии и команды фиксируются в разделе 9.1 (smoke test).

---

#### 2.1.7 Что нужно от вас, чтобы сделать 2.1 точным (без предположений)

⚠️ Нужны факты по изделию/релизу:
1) перечень реально поддерживаемых модулей и устройств (ID/типы);
2) какие протоколы включены в релизе прошивки (Modbus RTU/TCP, IEC-104, прочее);
3) как устроена конфигурация: SD/Flash, структура файлов, дефолты;
4) список функций студии (что именно конфигурируется: каналы, логика, протоколы).

Следующий пункт по оглавлению: 2.2 Условия эксплуатации (температура, влажность, вибрации — если задано).


## 4.1 Вход питания и защита

ℹ️ **Контекст**  
Плата контроллера установлена в пластиковом корпусе. **PE/шасси** на плату не заводится; используется двухпроводное питание **+24V / 0V (GND)**.

---

### 4.1.1 Подключение питания и интерфейса

**Разъём:** Phoenix Contact, 5-контактный push-in (**X2X**).  
Функциональное назначение контактов:
- **+24V, 0V (GND)** — питание
- **средний контакт** — **NC** (не используется)
- **RS-485 A/B** — связь с модулями

⚠️ **Риск ошибки монтажа проводов**  
Разъём исключает “переворот”, но провода в push-in можно перепутать. Маркировка распиновки возле X2X обязательна.
 
---

### 2.2 Условия эксплуатации (температура, влажность, вибрации)

Цель раздела: зафиксировать условия эксплуатации, на которые ориентирована аппаратная часть платы LCP
(питание, корпуса компонентов, выбор разъёмов, запас по теплу и надёжность).

⚠️ Примечание.
По текущим данным у нас нет формального ТЗ с климатикой/вибрацией.
Ниже — скелет, который нужно заполнить фактами. Если фактов нет, фиксируем как “не нормировано”,
а ограничения выводим из здравого смысла эксплуатации в шкафу и из типовых компонентов.

---

#### 2.2.1 Среда установки и применение

- Тип установки: внутри электрического шкафа/корпуса, стационарное размещение.
- Корпус изделия: пластиковый (без подключения PE к корпусу платы).
- Основные внешние воздействия: нагрев в шкафу, помехи от силового оборудования, длинные линии связи.

Инвариант:
- плата не рассчитана на эксплуатацию в условиях прямого воздействия воды, конденсата, агрессивных газов и пыли без защиты корпуса.

---

#### 2.2.2 Температура

Требование (если нет ТЗ — фиксируем “целевое”):
- рабочий диапазон: [TBD] °C … [TBD] °C.
- хранение: [TBD] °C … [TBD] °C.

⚠️ Открытый вопрос.
Нужно определить, что считать “нормой” для продукта:
- 0…+40 °C (офис/дом),
- -20…+60 °C (шкаф/пром),
- или иной диапазон (по заказчикам/полевому опыту).

Практические ограничения (без норм пока):
- критичны узлы питания (+5V buck, LDO +3V3) по тепловому режиму,
- критичны разъёмы и контактные соединения (особенно microSD и клеммник),
- при “жарком шкафу” возможны отключения/нестабильность из-за перегрева LDO/PTC (если установлен).

---

#### 2.2.3 Влажность и конденсат

Требование (если нет ТЗ — фиксируем “не нормировано”):
- относительная влажность: [TBD] % при [TBD] °C, без конденсации.

Инвариант:
- конденсация на плате недопустима (риск утечек, коррозии, ошибок интерфейсов).

⚠️ Открытый вопрос.
Были ли реальные случаи конденсата/работы в холодном шкафу с прогревом?
Если да — нужно отдельно фиксировать рекомендации по корпусу/герметизации.

---

#### 2.2.4 Вибрация и механические воздействия

Требование:
- если изделие стационарное в шкафу: вибрация обычно не нормируется отдельно или задаётся “минимально”.
- ударные нагрузки: не предполагаются (не мобильное изделие).

Практические риски:
- разъёмы (Ethernet, microSD) и клеммник должны выдерживать монтаж/демонтаж,
- пайка тяжёлых компонентов (разъёмов) критична.

⚠️ Открытый вопрос.
Есть ли требования по транспортировке/перевозке (удар/вибрация) и упаковке?
Если да — добавим “условия транспортирования” в этот раздел или в приложение.

---

#### 2.2.5 Электромагнитная среда (связь с условиями эксплуатации)

Поскольку контроллер работает в шкафу:
- ожидаются помехи от БП, реле, частотников/приводов, длинных линий.
- на плате отсутствует TVS по входу +24V (по вашей правке), поэтому устойчивость к перенапряжениям ограничена архитектурой входной защиты (PTC/диод) и качеством внешнего БП.

Инвариант:
- требования по ЭМС и защите должны рассматриваться на уровне системы шкафа, а не только платы.
(Подробности в 2.4 и 4.1.)

---

#### 2.2.6 Что нужно от вас, чтобы 2.2 стал “закрытым”

⚠️ Нужны факты (выберите один путь):
A) Если есть ТЗ/контракт/паспорт изделия:
- рабочий диапазон температуры,
- влажность,
- требования по вибрации/удару.

B) Если формальных требований нет:
- типовые реальные условия эксплуатации (шкаф/дом),
- “самая жаркая” температура в шкафу по практике,
- были ли полевые проблемы из-за нагрева/влажности.

После этого я:
- зафиксирую диапазоны как “требования” или как “принятое допущение”,
- привяжу к ним риски и минимальные проверки (нагрев LDO/PTC и т.п.).

---

### 2.3 Требования по питанию (номинал/диапазон, потребление, пусковые токи)

Цель раздела: зафиксировать требования к внешнему питанию изделия и контрольные параметры потребления,
чтобы:
- корректно выбирать шкафной БП,
- диагностировать проблемы “не стартует/перезагружается”,
- понимать запас по току и теплу.

---

#### 2.3.1 Входное питание (внешний источник)

Номинал:
- +24V DC (шкафной источник питания).

Диапазон:
- рабочий диапазон: 24V ±10% (по вашему описанию шкафа).
- допустимый диапазон “по практике”: [TBD] (вы упоминали, что может выдерживать больше, но это нужно фиксировать аккуратно).

⚠️ Важно.
В схеме отсутствует TVS по входу +24V (по вашей правке),
поэтому стойкость к перенапряжениям/импульсам определяется:
- входной защитой (PTC + диод переполюсовки),
- качеством внешнего БП и помеховой обстановкой шкафа.

⛔ Ограничение.
Поведение при ошибочной подаче 220V AC/DC не нормируется и не гарантируется.

---

#### 2.3.2 Полярность и подключение

- Питание подаётся через разъём X2X (клеммник).
- Возможна ошибка переполюсовки на клеммах (провода можно подключить неправильно),
поэтому предусмотрена защита от обратной полярности (диод в цепи питания).

Инвариант:
- маркировка контактов питания возле клеммника должна сохраняться в производственных версиях.

---

#### 2.3.3 Потребление (режимы работы)

Потребление зависит от режима:
- Idle (плата включена, без активного обмена/без нагрузки по интерфейсам).
- Work (активный Ethernet + активный RS-485 + SD операции).
- Peak (кратковременные пики при старте, инициализации интерфейсов, работе светодиодов).

⚠️ Открытый вопрос.
Нужно заполнить численные значения:
- I_in_24V_idle = [TBD] A
- I_in_24V_work = [TBD] A
- I_in_24V_peak = [TBD] A (пусковой/кратковременный)

Пока значений нет, в ПЗ можно оставить формулировку:
- “потребление определяется прошивкой и активностью интерфейсов; для приемки используются измеренные эталонные значения (см. 9.1)”.

---

#### 2.3.4 Внутренние шины питания и нагрузка

Внутренние уровни:
- +5V формируется buck-преобразователем от +24V.
- +3V3 формируется LDO от +5V.

Назначение доменов:
- +3V3: МК ATSAM3X8E, W5500, SD и цифровая логика.
- +5V: RS-485 трансиверы и индикация/прочие 5V узлы (по текущей архитектуре).

Инвариант:
- основные уровни (+5V и +3V3) должны оставаться неизменными для сохранения аппаратно-программного контракта.

---

#### 2.3.5 Пусковые токи и старт

Возможные причины пикового потребления при старте:
- заряд входных/выходных конденсаторов buck,
- старт W5500 и периферии,
- включение индикации.

⚠️ Открытый вопрос.
Нужны фактические измерения пускового тока:
- форма пика (мс/с),
- амплитуда,
- есть ли “просадка” +24V при старте на длинных проводах.

Рекомендация для первого запуска/диагностики (см. 9.1):
- использовать лабораторный БП с ограничением тока и плавным подъёмом лимита.

---

#### 2.3.6 Требования к внешнему источнику питания (шкафной БП)

Минимальные требования к БП шкафа:
- стабильные +24V в заданном диапазоне,
- достаточный ток с запасом по пусковым пикам,
- низкий уровень пульсаций/помех (в пределах типовых промышленных БП),
- корректное заземление/организация 0V на уровне шкафа (важно для RS-485).

⚠️ Открытый вопрос.
Если есть конкретные требования/рекомендованный БП (модель/производитель),
их стоит указать здесь как “рекомендовано”.

---

#### 2.3.7 Что нужно от вас, чтобы 2.3 стал “закрытым”

⚠️ Нужны данные:
1) измеренные токи потребления (idle/work/peak) на эталонной плате;
2) допустимый расширенный диапазон входного питания (если хотите фиксировать больше чем ±10%);
3) есть ли реальные кейсы “не стартует из-за БП/проводов” (для примечаний).

---

### 2.4 Требования по ЭМС/помехоустойчивости и защите (ESD/EFT/surge — если применимо)

Цель раздела: зафиксировать, какие ожидания по помехоустойчивости закладывались,
какие меры реализованы на плате, и где граница ответственности “плата vs шкаф/система”.

⚠️ Важно.
Плата LCP проектировалась как часть системы (шкафа) и питается от внешнего 24V БП.
При этом по вашей правке:
- TVS по входу +24V на плате отсутствует.
Это означает, что часть мер по surge/EFT должна обеспечиваться шкафом (БП, разводка, внешняя защита).

---

#### 2.4.1 Нормирование / уровень требований

Если формальное требование задано ТЗ:
- указать стандарты (IEC/EN) и уровни испытаний.

Если формального требования нет:
- фиксируем как “не нормировано”, но описываем практические ожидания:
  - работа в типовом промышленном шкафу,
  - устойчивость к коммутационным помехам умеренного уровня,
  - устойчивость к ESD при обслуживании (в пределах аккуратного обращения).

⚠️ Открытый вопрос.
Есть ли у вас фактические критерии:
- IEC 61000-4-2 (ESD),
- IEC 61000-4-4 (EFT),
- IEC 61000-4-5 (Surge),
или это не требовалось контрактом.

---

#### 2.4.2 Архитектурные источники помех (контекст применения)

Типовые источники в шкафу:
- импульсные блоки питания 24V,
- реле/контакторы, индуктивные нагрузки,
- частотники/приводы,
- длинные линии RS-485,
- внешние сетевые линии Ethernet.

Риски:
- броски и провалы питания,
- наводки по 0V (земля/возврат),
- ESD при подключении кабелей,
- общие помехи по экранам и корпусу (особенно при пластиковом корпусе).

---

#### 2.4.3 Реализованные меры защиты на плате (as-built)

Питание +24V:
- защита от переполюсовки: диод в цепи питания (по вашему описанию).
- самовосстанавливающийся предохранитель (PTC) в цепи питания (по вашему описанию).
- TVS по входу +24V: отсутствует (по вашей правке).

Следствие:
- устойчивость к surge/импульсам на линии +24V зависит от внешнего БП и системы шкафа.

RS-485:
- устойчивость к помехам в значительной степени определяется трансиверами и топологией линии.
⚠️ Открытый вопрос: есть ли на линиях A/B ESD/TVS защита или это не предусмотрено (нужно подтвердить по схемам).

Ethernet:
- ESD/помехозащита определяется разъёмом, включением Shield и (возможной) ESD-обвязкой.
⚠️ Открытый вопрос: есть ли ESD-диоды на Ethernet и как подключён Shield.

microSD:
- защита обычно минимальная; критичны качество контакта и “чистота” +3V3.

---

#### 2.4.4 Граница ответственности “плата vs система шкафа”

То, что должна обеспечить система шкафа (если нет TVS на плате):
- корректный промышленный 24V БП с защитами,
- минимизация бросков на 24V (правильная разводка, подавление индуктивных нагрузок),
- организация 0V/PE на уровне шкафа (общая точка, минимизация петель),
- при необходимости — внешняя защита по питанию (TVS/варистор/фильтр) на входе шкафа.

То, что контролирует плата:
- формирование внутренних +5V и +3V3,
- работа интерфейсов при типовой помеховой обстановке,
- наличие сервисного восстановления (JTAG/NRST).

---

#### 2.4.5 Минимальные требования/рекомендации по подключению (практика)

Для питания:
- использовать промышленный 24V БП,
- по возможности короткие провода питания и корректное сечение,
- избегать совместной прокладки питания LCP с силовыми кабелями.

Для RS-485:
- витая пара, корректная топология (линия, без “звезды”),
- при необходимости оконечивание на концах,
- обеспечить reference/0V между устройствами, если требуется условиями линии.

Для Ethernet:
- стандартные экранированные/неэкранированные патч-корды по ситуации,
- избегать длинных параллельных участков рядом с силовыми кабелями.

---

#### 2.4.6 Минимальный план проверки помехоустойчивости (если нет стенда IEC)

Если нет сертификационных испытаний, практический минимум:
- тест стабильности при включении/выключении нагрузки шкафа (реле/клапаны),
- тест Ethernet/RS-485 на длинных линиях,
- тест при повышенной температуре шкафа,
- проверка, что устройство восстанавливается после кратковременного пропадания питания.

---

#### 2.4.7 Что нужно от вас, чтобы 2.4 стал “закрытым”

⚠️ Нужны ответы:
1) есть ли формальные требования по IEC 61000-4-2/-4/-5 и уровни;
2) были ли реальные проблемы с помехами/сбоями в поле (кейсы);
3) есть ли на RS-485/Ethernet защитные элементы (ESD/TVS) по схеме;
4) хотите ли вы в ПЗ указать рекомендацию “внешний TVS/фильтр по 24V на уровне шкафа”.

---

### 2.5 Требования по ремонтопригодности и диагностике
(LED, тест-точки, сервисные интерфейсы)

Цель раздела: зафиксировать, какие средства диагностики и обслуживания предусмотрены на уровне платы,
чтобы изделие можно было:
- быстро проверить после монтажа,
- диагностировать неисправность “в поле”,
- восстановить прошивку/работоспособность без автора.

⚠️ Примечание.
Ниже — скелет требований. Конкретика (номера LED, TP, pinout JTAG) уточняется по схемам/BOM/PCB.

---

#### 2.5.1 Общие требования к обслуживанию платы

1) Должен быть сервисный доступ для прошивки и восстановления:
- JTAG (или эквивалентный интерфейс),
- линия аппаратного reset (NRST).

2) Должны быть точки контроля питания:
- измерение +5V,
- измерение +3V3,
- (желательно) измерение +24V после входной защиты.

3) Должна быть базовая индикация состояния:
- питание/работа контроллера,
- статус SD,
- статус Ethernet,
- статус/активность RS-485 (если предусмотрено аппаратно).

Инвариант:
- средства диагностики не должны исчезать в новых ревизиях без компенсирующего решения.

---

#### 2.5.2 Индикация (LED) — требования

Требования к LED-индикации:
- LED должны однозначно отражать ключевые состояния системы.
- Назначения должны быть нанесены на шелкографию или однозначно документированы.

Минимальный набор статусов (целевой):
- PLC_OK (контроллер запущен/основной цикл работает),
- SD_OK (SD присутствует и/или конфигурация прочитана),
- ETH_LINK / ETH_ACT (линк/активность),
- RTS/Tx (передача по RS-485) — если применимо.

⚠️ Открытый вопрос.
Нужна таблица “LED → назначение → активный уровень → условие включения (ПО)”.

---

#### 2.5.3 Тест-точки и контрольные измерения (DFT минимум)

Требования:
- на плате должны быть доступные точки измерения для:
  - +24V (желательно),
  - +5V,
  - +3V3,
  - GND.
- точки должны быть доступны без демонтажа платы из корпуса (если это возможно конструктивно),
либо в ПЗ фиксируется, что для измерений требуется вскрытие корпуса.

Рекомендуемый формат фиксации:
- таблица TP (RefDes TPxx) → сигнал → ожидаемое значение → допуск → комментарий.

⚠️ Открытый вопрос.
Нужен список test-point (или хотя бы “где мерить” по RefDes/разъёмам) из схем/PCB.

---

#### 2.5.4 Сервисные интерфейсы

Обязательный сервисный интерфейс:
- JTAG для ATSAM3X8E (прошивка/отладка/восстановление).
- NRST как аппаратный reset.

Желательные сервисные возможности (если реализованы):
- консоль/диагностический UART,
- сервисные команды по Ethernet (diagnostic endpoint),
- режим “safe start” при ошибочной конфигурации SD.

⚠️ Открытый вопрос.
Нужно подтвердить:
- есть ли на плате UART-консоль выведенная разъёмом/падами;
- есть ли диагностический режим в прошивке.

---

#### 2.5.5 Требования к “восстановлению после ошибки” (анти-окирпичивание)

Минимальные требования:
- при ошибке прошивки должно оставаться минимум одно средство восстановления:
  - JTAG доступен всегда.
- прошивка не должна блокировать JTAG/NRST аппаратно.

Желательно:
- чтобы причина reset могла быть диагностирована (WDT/BOR/External reset), если это реализовано в ПО.

---

#### 2.5.6 Минимальные критерии приемки ремонтопригодности

Плата считается пригодной к сопровождению, если:
- доступны измерения +5V и +3V3,
- JTAG доступен (МК определяется отладчиком),
- NRST работает,
- LED-индикация корректно отражает состояния,
- предусмотрен минимальный протокол проверки (см. 9.1).

---

#### 2.5.7 Что нужно от вас, чтобы 2.5 стал “закрытым”

⚠️ Нужны данные:
1) список LED и их назначение (по схемам/PCB);
2) список test-point или места измерения (RefDes/разъёмы);
3) pinout JTAG разъёма (контакт → сигнал);
4) подтверждение: есть ли UART консоль/диагностические команды.

---


## 3. Общая архитектура (сверху вниз)

### 3.1 Структурная схема изделия (блоки и связи)

Цель раздела: дать “карту” платы LCP на уровне блоков, чтобы инженер сопровождения быстро понял:
- какие функциональные узлы есть,
- как они связаны,
- где границы ответственности (питание, вычисление, интерфейсы, хранение конфигурации).

⚠️ Примечание.
В финальной версии здесь обычно даётся картинка структурной схемы (Приложение A).
Пока ниже — текстовое описание структурной схемы (скелет) и список того, что нужно уточнить по схемам.

---

#### 3.1.1 Состав основных функциональных блоков (as-built)

Блок 1. Ввод питания +24V и первичная защита.
- Вход: +24V DC через разъём X2X.
- Защита: PTC (самовосстанавливающийся предохранитель) + диод защиты от переполюсовки.
- Примечание: TVS по входу +24V отсутствует (по текущему исполнению).

Блок 2. Преобразование питания.
- Buck: +24V -> +5V.
- LDO: +5V -> +3V3 (основной домен логики).

Блок 3. Вычислительный узел.
- МК ATSAM3X8E (ядро управления).
- Тактирование: кварц 12.0 MHz.
- RTC домен: кварц 32.768 kHz + батарея CR2032 (питание RTC при отсутствии +24V).

Блок 4. Ethernet интерфейс.
- Ethernet контроллер W5500.
- Связь с МК: SPI (MOSI/MISO/SCK + CS, возможно INT/RESET — уточнить).
- Внешний интерфейс: Ethernet разъём (RJ45).

Блок 5. RS-485 интерфейс(ы).
- Физический уровень: RS-485 трансиверы, питаемые от +5V.
- Внешний интерфейс: линии A/B на разъёме X2X (шина модулей).
- Управление направлением: TxEn (по логике МК).

Блок 6. Хранение конфигурации (microSD).
- Разъём microSD.
- Интерфейс: SPI + SD_Detect.
- Назначение: хранение конфигурационных файлов.

Блок 7. Индикация/сервис.
- LED статусы (PLC_OK, SD_OK, ETH Link/Act, RTSx — по схемам уточнить).
- Сервис: JTAG + NRST для прошивки/восстановления.

---

#### 3.1.2 Связи между блоками (ключевые интерфейсы)

Питание:
- +24V -> (защита) -> buck -> +5V -> LDO -> +3V3.
- +5V: питание RS-485 узлов и индикации (по текущей архитектуре).
- +3V3: питание МК, W5500, SD, цифровых цепей.

Данные:
- МК <-> W5500 по SPI.
- МК <-> microSD по SPI (отдельный CS).
- МК <-> RS-485 трансивер(ы) по UART + TxEn.
- МК -> LED (GPIO), возможно через ключи/буферы (уточнить).

Сервис:
- JTAG/NRST напрямую к МК.

---

#### 3.1.3 Инварианты архитектуры (что нельзя ломать без новой ревизии)

1) Power-tree: +24V -> +5V -> +3V3 (и назначение доменов).
2) МК ATSAM3X8E (ядро вычисления).
3) W5500 как Ethernet узел и его SPI-связь с МК.
4) Наличие RS-485 шины на X2X.
5) microSD как источник конфигурации (если используется в продукте).
6) Сервисный путь восстановления: JTAG + NRST.

---

#### 3.1.4 Открытые вопросы (для “закрытия” структурной схемы)

⚠️ Нужны уточнения по схемам/файлам:
1) Сколько RS-485 трансиверов/портов реально на плате (1 или больше).
2) Есть ли у W5500 линии INT/RESET, и куда они заведены.
3) Как реализованы LED (напрямую от GPIO или через ключи).
4) Есть ли дополнительные сервисные интерфейсы (UART-консоль).

После того как вы загрузите полный PDF схем (или подтвердите, что он уже загружен),
я:
- переведу этот раздел в “без предположений”,
- сделаю в Приложении A структурную схему (картинка),
- и проставлю ссылки на RefDes (Uxx, Jxx, X2X и т.п.).

---

### 3.2 Дерево питания (power-tree)

Цель раздела: зафиксировать архитектуру питания платы LCP:
- какие напряжения формируются,
- какие узлы от каких доменов питаются,
- какие цепи считаются критичными для устойчивости,
- какие точки контроля (TP) нужны для диагностики.

⚠️ Примечание.
В финальной версии рекомендуется дать графическую схему power-tree (Приложение B).
Пока ниже — текстовый вариант (скелет), привязанный к нашей текущей информации.

---

#### 3.2.1 Входной домен: +24V (VIN)

Источник:
- внешний шкафной БП +24V DC.

Ввод:
- разъём X2X (клеммник).

Защита/входная цепь (as-built):
- PTC (самовосстанавливающийся предохранитель) последовательно по входу.
- диод защиты от переполюсовки.
- TVS по входу +24V отсутствует (по текущему исполнению).

Контроль:
- рекомендуется иметь контрольную точку “VIN после защиты” (если предусмотрено TP) для диагностики.
⚠️ Открытый вопрос: есть ли TP на VIN после PTC/диода.

---

#### 3.2.2 Промежуточный домен: +5V

Формирование:
- buck-преобразователь: +24V -> +5V.

Назначение +5V:
- питание RS-485 трансиверов,
- питание светодиодов индикации (и/или их драйверов),
- питание входа LDO +3V3.

Инвариант:
- +5V является обязательным промежуточным доменом для данной архитектуры.

Контроль:
- контрольная точка +5V (TP_5V) обязательна для диагностики (см. 9.1/9.2).
⚠️ Открытый вопрос: точное обозначение TP и место измерения (RefDes).

---

#### 3.2.3 Основной домен логики: +3V3

Формирование:
- LDO: +5V -> +3V3.

Назначение +3V3:
- МК ATSAM3X8E (основное питание),
- Ethernet контроллер W5500,
- microSD интерфейс,
- прочая цифровая логика на плате.

Критичность:
- +3V3 — самый критичный домен: просадки/пульсации прямо влияют на старт, связь и устойчивость работы.

Контроль:
- контрольная точка +3V3 (TP_3V3) обязательна.
⚠️ Открытый вопрос: точное обозначение TP и место измерения.

---

#### 3.2.4 RTC/резервный домен (если применяется)

Назначение:
- сохранение хода часов реального времени (RTC) при отсутствии основного питания.

Реализация:
- батарея CR2032.
- диодная развязка: питание RTC от батареи только при отсутствии +24V.

Потребители:
- RTC домен МК (или выделенная часть схемы RTC).

⚠️ Открытый вопрос.
Нужно подтвердить:
- какие именно цепи питаются от батареи (только VBAT/RTC или ещё что-то),
- есть ли ограничение/защита по батарее (резистор/диод/предохранение).

---

#### 3.2.5 Таблица power-tree 

Источник -> Преобразование -> Домен -> Потребители (основные)

- VIN +24V -> (PTC + диод) -> +24V_INTERNAL -> buck вход
- +24V_INTERNAL -> buck -> +5V -> RS-485, LED, вход LDO +3V3
- +5V -> LDO -> +3V3 -> ATSAM3X8E, W5500, microSD, цифровая логика
- CR2032 -> (диодная развязка) -> VBAT/RTC -> RTC домен (МК)

---

#### 3.2.6 Инварианты дерева питания (что нельзя ломать)

1) Вход +24V через X2X.
2) Наличие доменов +5V и +3V3 и их назначение.
3) Разделение: интерфейсные узлы на +5V, логика на +3V3 (как задумано в текущей плате).
4) RTC домен (если используется батарея) — не должен паразитно питать основную логику.

---

#### 3.2.7 Что нужно от вас, чтобы 3.2 стал “закрытым” с цифрами

⚠️ Нужны данные:
1) точные RefDes buck и LDO (+их номиналы/токи) — из схем/BOM;
2) точки измерения (TP) для VIN/+5V/+3V3;
3) типовые токи потребления по доменам (если есть измерения);
4) подтверждение, что buck именно +5V (вы уже подтвердили) и что питание RS-485/LED от +5V.

---

### 3.3 Коммуникационные интерфейсы (RS-485 / Ethernet / прочее) и топология

Цель раздела: описать “коммуникационную архитектуру” LCP:
- какие интерфейсы доступны на плате,
- их назначение и роли в системе,
- логическая топология (как подключается внешняя периферия),
- ключевые ограничения, которые нельзя нарушать при развитии.

⚠️ Примечание.
Этот раздел — про интерфейсы на уровне железа и системной топологии.
Протокольная часть раскрывается в разделе 8.

---

#### 3.3.1 Ethernet (основной сетевой интерфейс)

Назначение:
- связь с верхним уровнем (SCADA/HMI/студия конфигурации),
- сетевые протоколы: Modbus TCP, IEC 60870-5-104 (по факту прошивки).

Аппаратная реализация:
- Ethernet контроллер W5500.
- Связь МК ↔ W5500: SPI.
- Наружу: Ethernet разъём (RJ45), стандартная сеть.

Топология:
- типовая “звезда” через коммутатор/роутер шкафа или локальную сеть объекта.

Ограничения (типовые):
- ограничение числа одновременных TCP-сессий определяется W5500 и реализацией стека ПО.
⚠️ Открытый вопрос: сколько сокетов W5500 реально задействовано в прошивке.

Инварианты:
- W5500 как аппаратная платформа Ethernet.
- SPI-линии и CS/служебные сигналы W5500 (pin mapping) — часть контракта.

---

#### 3.3.2 RS-485 (интерфейс полевой шины / модулей)

Назначение:
- подключение периферийных модулей LCP (шинная архитектура),
- и/или подключение внешних устройств (газоанализаторы, расходомеры и т.п.) в зависимости от прошивки и схемы портов.

Аппаратная реализация:
- RS-485 трансивер(ы), питание от +5V.
- Управление направлением: TxEn (или аналогичный сигнал).
- Наружу: линии A/B на разъёме X2X (как минимум для “шины модулей”).

Топология (типовая для RS-485):
- линия (daisy-chain), без “звезды”,
- оконечивание на концах линии (если предусмотрено/применимо),
- витая пара для A/B.

Критичное системное условие:
- наличие общего reference/0V между устройствами (в зависимости от условий линии).
В текущем изделии PE не заведён (пластиковый корпус), поэтому вопрос reference должен решаться на уровне шкафа/кабеля.

Инварианты:
- назначение A/B и их вывод на разъём.
- параметры физического уровня (трансивер, управление направлением) должны оставаться совместимыми.

⚠️ Открытый вопрос.
Нужно уточнить:
- сколько RS-485 портов реально на плате (1 или более),
- только ли X2X несёт RS-485 или есть отдельные разъёмы/порты.

---

#### 3.3.3 Прочие интерфейсы (если присутствуют)

Возможные интерфейсы на уровне МК (в зависимости от схемы):
- UART (консоль/сервис),
- SPI (кроме W5500/SD),
- I2C (датчики/расширения),
- ADC/DAC (измерения/управление),
- GPIO для дискретных входов/выходов.

⚠️ Открытый вопрос.
Нужно подтвердить по полной схеме:
- какие из этих интерфейсов реально разведены на разъёмы/пады,
- какие используются только внутренне.

---

#### 3.3.4 Логическая топология системы (в контексте изделия)

Типовой вариант применения LCP:
- Ethernet: связь с верхним уровнем (конфигуратор/SCADA).
- RS-485: шина периферийных модулей LCP (распределённые I/O модули).
- microSD: локальный носитель конфигурации (параметры системы).

---

#### 3.3.5 Ограничения и инварианты (итог по интерфейсам)

Ethernet:
- нельзя менять W5500 без изменения прошивки и тестов.
- нельзя менять SPI pin mapping без изменения прошивки.

RS-485:
- нельзя менять назначение A/B, управление TxEn и параметры линии без проверки на устойчивость.
- топология должна соответствовать RS-485 (линия, оконечивание, помехоустойчивость).

Сервис:
- JTAG/NRST должны сохраняться для восстановления.

---

#### 3.3.6 Что нужно от вас, чтобы 3.3 стал “закрытым” и конкретным

⚠️ Нужны данные/файлы:
1) полный PDF схем, чтобы точно указать:
   - количество RS-485 трансиверов и куда выведены,
   - сигналы W5500 (CS/INT/RESET),
   - наличие UART консоли.
2) “как в продукте принято подключать модули”:
   - максимальная длина линии,
   - тип кабеля,
   - наличие оконечивания/подтяжек,
   - типовые скорости RS-485.

---


### 3.4 Варианты исполнения / ревизии (если есть Rev.A / Rev.B и отличия)

Цель раздела: зафиксировать, какие исполнения платы LCP существовали (или существуют),
чем они отличаются, и как это влияет на:
- совместимость прошивки,
- совместимость корпуса/разъёмов,
- производственные файлы (Gerber/BOM),
- сервис и диагностику.

⚠️ Примечание.
Если ревизия одна, раздел остаётся коротким и фиксирует “единственную базовую ревизию”.
Если ревизий несколько — в конце раздела нужна таблица отличий.

---

#### 3.4.1 Текущая базовая ревизия (as-built)

Базовая ревизия платы:
- Rev: [TBD]
- Дата/период производства: [TBD]
- Основной комплект файлов: [TBD] (ссылка на релиз/тег репозитория)

⚠️ Открытый вопрос.
Нужны:
- обозначение ревизии на плате (silk / title block),
- или версия проекта Altium/релиза.

---

#### 3.4.2 Известные варианты исполнения (если применимо)

Возможные причины существования вариантов:
- замены компонентов из-за доступности (BOM swap),
- косметические/DFM правки,
- изменения разъёмов под другой корпус,
- изменения питания (buck/LDO),
- изменения интерфейсов (RS-485 портов, SD держатель и т.п.).

На текущем этапе:
- перечень вариантов: [TBD] (пока не подтверждено).

---

#### 3.4.3 Матрица отличий (шаблон)

Для каждой ревизии фиксируем:

Ревизия: Rev.[X]
- Отличия по схеме:
  - …
- Отличия по PCB:
  - …
- Отличия по BOM:
  - …
- Совместимость прошивки:
  - (совместима / требуется отдельная сборка / требуется изменение pin mapping)
- Совместимость корпуса/механики:
  - (совместима / требуется другой корпус / ограничение доступа microSD)
- Сервис/диагностика:
  - (изменения JTAG/TP/LED)

---

#### 3.4.4 Инварианты, которые должны сохраняться между ревизиями

Даже при изменениях ревизий желательно сохранять:
- распиновку основных разъёмов (X2X питание+RS-485, Ethernet, microSD),
- уровни питания +5V/+3V3,
- сервисный доступ (JTAG/NRST),
- аппаратную платформу Ethernet (W5500) и МК (ATSAM3X8E),
если цель — сохранять совместимость с существующим ПО и верхним уровнем.

---

#### 3.4.5 Что нужно от вас, чтобы 3.4 стал “закрытым”

⚠️ Нужны факты:
1) сколько ревизий реально было и как они обозначены;
2) были ли изменения по BOM/PCB/разъёмам;
3) есть ли “approved substitutions” (список замен) — можно вынести в 6.2/6.4;
4) если прошивка различалась по ревизиям — какие версии прошивки соответствуют каким ревизиям.

---

### 3.5 Инварианты аппаратной платформы (сводно: что нельзя менять без последствий)

Цель раздела: собрать в одном месте список аппаратных “инвариантов” LCP — то, что определяет совместимость
железа, прошивки, модулей и верхнего уровня. Любое нарушение этих пунктов требует отдельного решения,
как минимум: новая ревизия платы + изменение/валидация ПО + обновление документации.

---

#### 3.5.1 Инварианты вычислительного ядра

1) МК: ATSAM3X8E.
- Замена МК = новая аппаратная платформа и переработка прошивки.

2) Тактирование.
- кварц 12.0 MHz (база для таймингов, PLL, интерфейсов),
- кварц 32.768 kHz (RTC, если используется).
- Изменение частот/схемы тактирования = риск нестарта, сдвиг таймингов SPI/UART, деградация связи.

3) Сервисное восстановление.
- JTAG + NRST должны оставаться доступными аппаратно.
- Блокировка/удаление JTAG = высокий риск “окирпичивания” и невозможности поддержки.

---

#### 3.5.2 Инварианты сетевого интерфейса

1) Ethernet аппаратная платформа: W5500.
- Замена W5500 = изменение драйвера, стека, тестов и, вероятно, схемы/PCB.
- SPI-интерфейс к W5500 (MOSI/MISO/SCK + CS + служебные линии) — часть контракта.

2) Внешний разъём и механика Ethernet.
- тип и посадка разъёма должны сохраняться (совместимость корпуса/передней панели),
- включение Shield (экран) является ЭМС-критичным параметром и должно быть фиксировано.

---

#### 3.5.3 Инварианты шины RS-485

1) Наличие RS-485 физического интерфейса на разъёме X2X.
- линии A/B и их назначение должны сохраняться.

2) Электрический уровень.
- RS-485 трансиверы питаются от +5V (по текущей архитектуре).
- управление направлением (TxEn/RTS) и активные уровни — часть контракта.

3) Топология подключения.
- RS-485 подразумевает линию (daisy-chain), корректное оконечивание и reference/0V на уровне системы.
- Изменения, нарушающие эти принципы, дают нестабильный обмен в поле.

---

#### 3.5.4 Инварианты питания (power-tree)

1) Вход: +24V DC через X2X.
2) Дерево питания:
- +24V -> buck -> +5V -> LDO -> +3V3.
3) Назначение доменов:
- +3V3: МК, W5500, SD и цифровая логика,
- +5V: RS-485 и индикация/прочие 5V узлы.

Любая смена:
- уровней +5V/+3V3,
- порядка преобразований,
- назначения доменов
= архитектурное изменение и требует новой ревизии и повторной валидации.

---

#### 3.5.5 Инварианты хранения конфигурации

1) microSD как носитель конфигурации (если используется в продукте).
- интерфейс SPI и линии CS_SD/SD_Detect (активные уровни) — часть контракта.

2) Формат конфигурации и “контракт данных”.
- изменения форматов/структур = breaking change для студии/верхнего уровня (см. 8.3).

---

#### 3.5.6 Инварианты механики и разъёмов

1) Посадочные места и типы ключевых разъёмов:
- X2X (клеммник питания + RS-485),
- Ethernet разъём,
- microSD держатель,
- JTAG разъём.

2) Совместимость корпуса:
- высоты разъёмов/доступ к microSD/крепёжные отверстия.
- любые изменения по посадке = риск несовместимости корпуса и сборки.

---

#### 3.5.7 Инварианты “железо ↔ верхний уровень” (системный контракт)

1) Карта разъёмов и уровни сигналов (8.1).
2) Протоколы и их режимы/дефолты (8.2).
3) Модель данных, ID устройств и структуры обмена (8.3).

Нарушение этих инвариантов приводит к:
- несовместимости модулей,
- несовместимости студии конфигурации,
- необходимости миграции/перешивки/обновления верхнего уровня.

---

#### 3.5.8 Мини-чеклист перед любой модификацией

Перед изменением спросить:
- меняется ли МК / W5500 / кварцы / pin mapping? → это breaking.
- меняется ли дерево питания / уровни +5V/+3V3? → это breaking.
- меняется ли pinout разъёмов? → новая ревизия корпуса/PCB.
- меняется ли протокол/структуры данных? → обновлять 8.2/8.3 и делать совместимость.

---

4. Описание электрической схемы по функциональным узлам.


## 4. Описание электрической схемы по функциональным узлам

### 4.1 Вход питания и защиты (полярность, предохранение, TVS, фильтры, режимы отказа)

#### 4.1.1 Назначение узла и интерфейс ввода питания

Назначение:
- принять внешнее питание шкафа +24V DC и вернуть 0V,
- обеспечить базовую защиту от ошибок подключения и нештатных режимов,
- передать питание на узел преобразования (+24V -> +5V),
- обеспечить единый входной разъём для питания и шины RS-485 модулей.

Ввод питания:
- питание подаётся через разъём X2X (клеммник Phoenix Contact, 5 контактов, push-in).
- на X2X заведены:
  - +24V и 0V (два контакта),
  - линии RS-485 A/B (два контакта),
  - один контакт не используется (NC; ранее рассматривался как PE/земля).

Особенности “земля/корпус”:
- корпус изделия пластиковый, PE на плату не заводится.
- на плату подаётся только +24V и 0V (возврат).

Инвариант:
- назначение X2X как “питание + RS-485” должно сохраняться между ревизиями (см. 3.5).

⚠️ Открытый вопрос (для таблицы pinout в 8.1):
Нужна точная распиновка X2X (контакт 1..5 → назначение) по схеме/шелкографии.

---

#### 4.1.2 Реализованные меры защиты и фильтрации (as-built)

Состав входной защиты (по текущему исполнению):
1) PTC (самовосстанавливающийся предохранитель) в цепи питания.
   - задача: ограничить ток при аварии/перегрузке, обеспечить “самовосстановление” после устранения причины.

2) Диод защиты от переполюсовки.
   - задача: предотвратить повреждение платы при неправильном подключении +24V/0V на клеммнике.

TVS (по питанию):
- TVS-диод по входу +24V отсутствует (уточнено вами).
- следствие: защита от surge/EFT по линии питания должна обеспечиваться внешним шкафом (БП/внешняя защита).

Фильтрация/емкости:
- на входе и по цепи питания присутствуют конденсаторы (входные/развязка) для локальной фильтрации и стабилизации.
- детальные номиналы и RefDes фиксируются по схеме/BOM (в разделе 4.2 и в приложении “контрольные точки/напряжения”).

Режимы отказа (ожидаемое поведение):
- переполюсовка: диод блокирует ток, плата не запускается, повреждений не должно быть (при разумных уровнях).
- перегрузка/короткое: PTC уходит в высокоомное состояние, ограничивает ток; после снятия аварии восстанавливается.
- перенапряжение: при отсутствии входного TVS поведение определяется внешним источником питания и ограничением входных компонентов; стойкость к высоким перенапряжениям не нормируется.

⛔ Ограничение.
Поведение при ошибочной подаче 220V не нормируется и не гарантируется.

⚠️ Открытые вопросы (для “закрытия” раздела):
1) RefDes и параметры PTC (тип/ток удержания/срабатывания) — из BOM.
2) RefDes и тип диода переполюсовки (корпус, ток, падение напряжения) — из BOM.
3) Наличие/номиналы входных конденсаторов и их расположение (вблизи разъёма/вблизи buck) — из схем.
4) Нужна ли фиксация “рекомендованной внешней защиты” (TVS/фильтр) на уровне шкафа — решение владельца продукта.

---

### 4.1.3 Последовательность узла питания (по схеме)

Цепочка по входу **+24V**:

1) **F2 — PTC (самовосстанавливающийся предохранитель)**  
   Тип: *MF-MSMF030-2 (I_hold ≈ 0.50 A)*.

2) **D2 — защита от переполюсовки (серийный Schottky)**  
   Тип: *B360A-13-F*. При обратной полярности питание downstream-цепей блокируется.

3) **Входные конденсаторы (Cin)**  
   Локальная ёмкость у входа DC/DC (на схеме, например, **C15 10 µF**).

4) **U2 — DC/DC buck-преобразователь**  
   Микросхема: **TPS54331** (TI). Формирует **+5V**.

5) Силовая часть buck:
   - **D1 — диод свободного хода:** *B360A-13-F*
   - **L5 — дроссель выходного фильтра**
   - **Cout — выходные конденсаторы:** C2/C9/C10 по 22 µF (суммарно 66 µF)

6) **TVS1 — защита вторичного рельса +5V**  
   Тип: **SMAJ5.0CA** (двунаправленный TVS) — защита +5V от импульсных перенапряжений.

ℹ️ **Назначение рельсов**
- **+5V (после buck)**: питание **RS-485 драйверов** и **индикаторных LED**.
- **+3V3 (после LDO, см. 4.2)**: питание основной электроники — **ATSAM3X8E**, **W5500** и др.

---

### 4.1.4 Расчётные параметры DC/DC (WEBENCH, справочно)

ℹ️ **Источник данных**  
WEBENCH Design Report: *TPS54331DDAR 14V–26V → 5.00V @ 2A*.:contentReference[oaicite:0]{index=0}

**Design inputs (из отчёта):**
- VinMin = **14.0 V**, VinMax = **26.0 V**
- Vout = **5.0 V**
- Iout = **2.0 A**:contentReference[oaicite:1]{index=1}

**Operating values (точка Vin=26V, Iout=2A):**
- Switching frequency: **570.0 kHz**:contentReference[oaicite:2]{index=2}
- Efficiency: **87.34 %**:contentReference[oaicite:3]{index=3}
- Total power dissipation: **1.449 W**:contentReference[oaicite:4]{index=4}
- Average input current (Iin Avg): **440.36 mA**:contentReference[oaicite:5]{index=5}
- Bode crossover frequency: **17.902 kHz**:contentReference[oaicite:6]{index=6}
- Phase margin: **60.974°**:contentReference[oaicite:7]{index=7}
- Output ripple (Vout p-p): **2.333 mV**:contentReference[oaicite:8]{index=8}
- Расчётные температуры: **IC Tj 64.756°C**, **D1 Tj 114.49°C**:contentReference[oaicite:9]{index=9}

⚠️ **Граница по входному напряжению (важно)**  
Расчёт WEBENCH выполнен до **VinMax = 26.0 V**:contentReference[oaicite:10]{index=10}. Если в изделии декларируется “24V +10%” (26.4V), это выходит за границу расчёта и должно подтверждаться даташитом/испытанием.

⚠️ **Замечание по входному PTC (тепловой запас)**  
При полной нагрузке (10 W на выходе) расчётный **Iin Avg ≈ 0.44 A**:contentReference[oaicite:11]{index=11}, что близко к **I_hold ≈ 0.50 A** у MF-MSMF030-2. При повышенной температуре/пусковых режимах запас может быть небольшим — это нужно проверять испытанием (самосрабатывание PTC при жаре шкафа).

---

### 4.1.5 Поведение при ошибках подключения

✅ **Переполюсовка питания**  
D2 (Schottky) блокирует питание downstream-цепей. Ожидаемое поведение: устройство не запускается без разрушения элементов (в пределах разумных напряжений источника).

⚠️ **Перегрузка / короткое замыкание**  
PTC F2 ограничивает ток (нагрев/рост сопротивления). После устранения причины должен восстановиться.

⛔ **Перенапряжение по входу +24V**  
**TVS на входе +24V отсутствует** (как реализовано в текущей ревизии). Стойкость к перенапряжениям по входу **не нормируется**; защита входа определяется допустимыми режимами DC/DC и общим запасом элементов. Добавление входного TVS (и/или входного EMI-ввода) — предмет улучшений ревизии платы (см. 9.3).

---

### 4.1.6 Диагностика (минимум, без выпайки)

1) Проверить **VIN** на клеммнике X2X.  
2) Проверить **VIN после F2/D2** (на входе VIN микросхемы TPS54331).  
3) Проверить наличие **+5V** на выходных конденсаторах (C2/C9/C10).  
4) При аномалиях — термоконтроль:
   - перегрев **F2** → работа в ограничении / перегрузка
   - перегрев **D2** → повышенный ток (учитывать падение напряжения на диоде)

ℹ️ Номера test-point и ожидаемые уровни будут внесены в Приложение D после формирования TP-карты платы.

---

### 4.1.7 Что включать из отчёта WEBENCH (графики/таблицы)

ℹ️ **Рекомендация по объёму в ПЗ**  
В основной текст 4.1 достаточно:
- краткой таблицы ключевых параметров (см. 4.1.3),
- ссылки на WEBENCH PDF в репозитории.

---


## 4.2 Стабилизаторы и опорные напряжения

### 4.2.1 Общая структура питания

Питание платы разделено на два основных домена.

- +5V формируется импульсным понижающим преобразователем (buck) от входного +24V.
- +3V3 формируется линейным стабилизатором (LDO) от +5V.

ℹ️ По схеме: buck TPS54331 (U2) формирует +5V. Далее LDO LM1117MPX-3.3 (U3) формирует +3V3.

---

### 4.2.2 Преобразователь +24V → +5V (buck на TPS54331)

Назначение узла: преобразовать входные 24 V в стабилизированные +5V.

+5V используется для:
- питания драйверов RS-485;
- питания цепей индикации (LED);
- прочих 5-вольтовых нагрузок, если они есть на плате.

Состав узла по схеме:
- U2: TPS54331 (buck DC/DC).
- D1: B360A-13-F (диод силового контура).
- L5: дроссель выходного фильтра (номинал уточняется по BOM).
- C2/C9/C10: 22 µF × 3 на выходе (керамика, суммарно 66 µF).
- C15: 10 µF на входе.
- C23: 0.1 µF (bootstrap BOOT).
- Компенсация/SS/VSENSE: элементы вокруг COMP/SS/VSENSE (см. лист питания).

ℹ️ WEBENCH-отчёт `WBDesign8.pdf` использовался как расчётная база (design intent). В отчёте: TPS54331, Vin 14…26 V, Vout 5.0 V, Iout 2.0 A.

⚠️ Важно. WEBENCH-расчёт — это референс разработки, но фактические номиналы на плате могут отличаться. Источник истины для производства: схема и BOM.

Контроль и диагностика (минимум):
- проверить наличие +24V на входе узла DC/DC (после входной защиты);
- проверить наличие +5V после L5 и на конденсаторах C2/C9/C10;
- при перегрузке: контролировать нагрев U2, D1 и L5, а также просадку +5V.

⚠️ Открытый вопрос по обозначению “L5 = SMAJ5.0CA”. По схеме L5 выглядит как дроссель, а TVS обозначен отдельным элементом TVS1. Подтвердите, пожалуйста:
- L5 — это дроссель (и его номинал/тип);
- SMAJ5.0CA относится к TVS1 (защита +5V), а не к L5.

---

### 4.2.3 Линейный стабилизатор +5V → +3V3 (LDO на LM1117-3.3)

Назначение узла: сформировать шину +3V3 для цифровой электроники.

Потребители +3V3:
- SAM3X8E (основной микроконтроллер);
- W5500 (Ethernet);
- прочие 3.3V цепи.

Состав узла по схеме:
- U3: LM1117MPX-3.3 (LDO).
- Конденсаторы по фрагменту: C32 0.1 µF, C24 22 µF (уточнить полный набор по листу питания и BOM).

ℹ️ Обвязка LDO выполнена по референсной схеме из даташита (исторический design intent). В ПЗ фиксируем текущее исполнение “as-built”, без оценки “хорошо/плохо”.

⚠️ Тепловой режим LDO важен при модернизации.
LDO рассеивает: P ≈ (5.0 − 3.3) × I3V3.
Например, при I3V3 = 0.30 A получаем P ≈ 0.51 W. Это уже заметно для SOT-223 без хорошего теплоотвода.
При увеличении нагрузки 3.3V нужно проверять нагрев U3 и стабильность +3V3.

---

### 4.2.4 Инварианты питания (что нельзя “сломать” при развитии)

- Логика и Ethernet часть рассчитаны на +3V3. Изменение уровня питания недопустимо.
- Нагрузка по +5V должна оставаться в пределах возможностей buck-преобразователя и входной защиты.
- Рост потребления +3V3 напрямую увеличивает тепловую нагрузку на LDO. Любые новые потребители 3.3V требуют проверки нагрева и просадок.

---

### 4.2.5 WEBENCH-графики: включать или нет

ℹ️ Рекомендация: в основной текст 4.2 включать только краткое описание design intent и ключевые параметры (Vin/Vout/Iout, микросхема, принципиальная структура).
Графики (КПД, пульсации, Bode, тепловые) лучше оставить в виде отдельного файла `WBDesign8.pdf` в репозитории и просто сослаться на него.
Это сохраняет читаемость ПЗ и при этом не теряет инженерный “след” расчёта.

---

## 4.3 МК/SoC и обвязка (тактирование, reset, boot, watchdog, brown-out)

### 4.3.1 Назначение и выбор МК

На плате используется микроконтроллер семейства SAM3X8E.

- U1: ATSAM3X8EA-AU. :contentReference[oaicite:0]{index=0}

МК выполняет функции:
- выполнение основной логики контроллера;
- работа с интерфейсами (UART/SPI/I2C, GPIO);
- взаимодействие с Ethernet-узлом (через SPI и служебные сигналы);
- сервисные функции (индикация, диагностика).

ℹ️ Подробное соответствие “пин → функция” фиксируем в разделе 8.1 (карта разъёмов/линий) и в приложении “pin map”.

---

### 4.3.2 Питание МК и разделение доменов

Основное питание цифровой части: +3V3.

По схеме у МК присутствуют отдельные домены питания, включая:
- +3V3 (основная логика);
- VDDBU (backup domain для RTC/backup-логики). :contentReference[oaicite:1]{index=1}

⚠️ Инвариант.
+3V3 является базовым уровнем питания МК. Любые изменения шины +3V3, LDO, фильтрации, или распределения “земля/питание” требуют проверки запуска, стабильности тактирования и устойчивости Ethernet/периферии.

---

### 4.3.3 Тактирование (основной кварц и RTC)

На плате предусмотрены два кварцевых резонатора:

1) Основной кварц: XTL6 12.0 MHz. :contentReference[oaicite:2]{index=2}
2) Кварц RTC: XT1 32.768 kHz. :contentReference[oaicite:3]{index=3}

Назначение:
- 12 MHz используется как базовый источник для системного тактирования МК (через PLL, по типовой схеме).
- 32.768 kHz используется для низкопотребляющего RTC/backup-домена.

⚠️ Инвариант.
Номиналы кварцев и их обвязка (нагрузочные ёмкости, трассировка, земля) критичны для запуска и стабильности. Замена кварцев допустима только при соблюдении параметров нагрузки и ESR по даташиту и при проверке старта в температуре.

---

### 4.3.4 Reset и сервисный сброс

В схеме присутствует линия MASTER-RESET (глобальный сброс). :contentReference[oaicite:4]{index=4}

Назначение:
- обеспечить принудительный сброс МК внешним сигналом;
- увязать сброс МК с сервисными цепями и, при необходимости, с узлами периферии.

⚠️ Открытый вопрос.
По PDF видно имя сети MASTER-RESET, но не видно полного состава цепи (кнопка/RC/супервизор) в этой выжимке. В 4.3 нужно подтвердить по листу, где расположена цепь reset:
- есть ли отдельная микросхема supervisor/brown-out reset;
- есть ли кнопка reset;
- как выполнены подтяжки и RC-формирование фронта.

---

### 4.3.5 Интерфейс отладки (JTAG)

Для отладки/прошивки предусмотрены JTAG-сигналы:
- JTAG_TMS, JTAG_TCK, JTAG_TDO, JTAG_TDI. :contentReference[oaicite:5]{index=5}
Также в таблице связей видно JTAG_TMS как именованную сеть. :contentReference[oaicite:6]{index=6}

ℹ️ Назначение.
JTAG используется для низкоуровневой отладки и программирования на этапе разработки/сервиса.

⚠️ Инвариант.
Линии JTAG нельзя нагружать сторонними схемами или использовать как GPIO без проверки, иначе теряется возможность отладки и восстановления платы.

---

### 4.3.6 RTC и батарейное питание backup-домена

Для сохранения хода времени и состояния backup-домена при отсутствии основного питания предусмотрено питание VDDBU от батареи CR2032.

По схеме:
- B1: держатель батареи CR2032. :contentReference[oaicite:7]{index=7}
- D4: BAT54C (диодная развязка/OR-ing). :contentReference[oaicite:8]{index=8}
- питание VDDBU выведено как отдельная сеть. :contentReference[oaicite:9]{index=9}

Назначение:
- при наличии +3V3 backup-домен питается штатно;
- при пропадании +3V3 backup-домен (VDDBU) поддерживается от батареи.

⚠️ Инвариант.
Цепь VDDBU не должна питать основную цифровую часть. Любые изменения в развязке BAT54C/VDDBU требуют проверки отсутствия паразитного подпиточного тока в +3V3 и корректной работы RTC.

---

### 4.3.7 Watchdog и brown-out

ℹ️ По PDF в явном виде не видна отдельная внешняя микросхема watchdog/supervisor. В “as-built” описании фиксируем так:

- watchdog: по умолчанию предполагается использование встроенного WDT SAM3X8E (если не предусмотрено внешней логики);
- brown-out: по умолчанию предполагается использование внутренних механизмов контроля питания МК (если не предусмотрено внешней логики).

⚠️ Открытые вопросы (нужны для закрытия 4.3 в финале).
1) Используется ли в прошивке аппаратный WDT SAM3X8E (да/нет, режим).
2) Настроен ли brown-out в МК (порог/режим) или есть внешний supervisor.

---

### 4.3.8 Boot-режимы и “восстановление” платы

⚠️ Открытый вопрос.
В этой выжимке PDF не видно, как реализованы линии boot/erase/test (перемычки, кнопки, подтяжки). Для практической сопровождаемости важно явно зафиксировать:
- есть ли аппаратный способ перевода МК в режим прошивки/восстановления;
- какие действия доступны без программатора (если доступны).

-----

## 4.4 Память и хранение конфигурации (Flash/FRAM/EEPROM/SD)

### 4.4.1 Общая логика хранения

В текущей аппаратной реализации предусмотрено хранение конфигурации на съёмном носителе microSD.
Подключение microSD выполнено по SPI.

Отдельные внешние микросхемы EEPROM/FRAM в тех листах схемы, которые сейчас есть в составе проекта, не выделены отдельным узлом.
Если в проекте есть отдельный лист “EEPROM/FRAM/Memory” или другая ревизия платы, это нужно будет подтвердить и дописать.

⚠️ Открытый вопрос.
Хранится ли часть параметров во внутренней Flash МК (например, сетевые настройки, адреса, калибровки), или всё хранится только на SD.
Это относится к контракту “железо ↔ прошивка”, и без данных из ПО мы это не фиксируем как факт.

---

### 4.4.2 microSD (SD1): назначение и включение

Назначение: хранение конфигурационных файлов и пользовательских данных контроллера на съёмной карте.

Узел SD:
- SD1: держатель microSD (тип указан в схеме и/или BOM)
- питание SD: +3V3
- локальная развязка питания SD: конденсатор 0.1 µF рядом с разъёмом

Интерфейс SPI:
- MOSI
- MISO
- SPCK (SCLK)
- CS_SD (chip select)

Служебные линии:
- SD_Detect (детект наличия карты)

Подтяжки:
- CS_SD имеет подтяжку к лог.1 (типично 10 kΩ)

ℹ️ Смысл подтяжки CS_SD.
Подтяжка задаёт “невыбранное” состояние карты при старте и до инициализации SPI.
Это снижает риск некорректного поведения SD при включении питания и при reset.

---

### 4.4.3 Внутренняя Flash микроконтроллера

Микроконтроллер ATSAM3X8E имеет встроенную Flash-память, используемую для прошивки.

Если проектом предусмотрено хранение части параметров во Flash (например, критичные настройки, которые не должны зависеть от SD),
то в ПЗ нужно будет явно зафиксировать:
- какие именно параметры хранятся во Flash
- структура/версия данных
- механизм обновления
- защита от потери питания при записи

⚠️ Открытый вопрос.
На основании только схемы нельзя подтвердить, что параметры реально пишутся во Flash.
Это фиксируется по прошивке и документации верхнего уровня.

---

### 4.4.4 Инварианты и ограничения (что важно не сломать при развитии)

- Уровни сигналов SPI должны оставаться совместимыми с +3V3.
- Имена и назначение линий MOSI/MISO/SPCK/CS_SD/SD_Detect являются инвариантами для сопровождения и отладки.
- Подтяжка CS_SD должна сохраняться, чтобы карта гарантированно была “не выбрана” на старте.
- Локальная развязка питания SD рядом с разъёмом должна сохраняться.

⛔ Критично.
Любые изменения узла SD (питание, уровни, подтяжки, детект) требуют проверки:
- старта МК
- инициализации SD
- устойчивости чтения/записи
- поведения при горячей замене карты (если это допускается ПО)

---

### 4.4.5 Диагностика и типовые неисправности (скелет)

Если SD не определяется:
1) проверить наличие +3V3 на разъёме SD
2) проверить уровень на SD_Detect (соответствует ли наличию карты)
3) проверить, что CS_SD в “1” до инициализации и корректно переключается в работе
4) проверить качество контакта держателя и саму карту

Если чтение/запись нестабильны:
- проверить питание +3V3 (просадки, шум)
- проверить контакт держателя и качество карты
- в ПО проверить таймауты инициализации SPI и повторные попытки

ℹ️ Примечание.
Для удобства ремонта полезно иметь test-point на +3V3, CS_SD и SPCK.
Если TP на плате есть, они должны быть перечислены в Приложении D (контрольные точки).

---

## 4.5 Интерфейсы связи

### 4.5.1 RS-485

Назначение.
RS-485 используется для связи контроллера LCP с внешними модулями/устройствами по дифференциальной линии A/B.

Состав узла (по схеме).
- U5: SN65HVD1785D (RS-485 transceiver), питание +5V, общий GND :contentReference[oaicite:0]{index=0}
- U7: SN65HVD1785D (второй RS-485 transceiver), питание +5V, общий GND :contentReference[oaicite:1]{index=1}
- Управляющие сигналы к трансиверам: Rx, Tx, TxEn1, TxEn2 :contentReference[oaicite:2]{index=2}
- Линия шины: A и B :contentReference[oaicite:3]{index=3}

Разъёмная часть (по этому листу).
На шину выведены контакты, подписанные как:
- Pwr, A, B, Gnd (питание/шина/общий) :contentReference[oaicite:4]{index=4}

ℹ️ Примечание.
По этому фрагменту видно, что логика управления передачей разделена на TxEn1/TxEn2.
Это типично для управления направлением (DE/RE) и/или для обеспечения нужного режима приёма/передачи.

⚠️ Открытые вопросы (по PDF-видимости).
1) Сколько всего физических портов RS-485 на плате и как они называются (X…).
2) Есть ли оконечивание 120 Ом на стороне контроллера, и как оно включается (постоянно/перемычкой/опционально).
3) Есть ли защитные элементы на A/B (TVS, последовательные резисторы, RC), и где они стоят.
Для закрытия этих пунктов нужен полный лист RS-485 со всей обвязкой.

Инварианты (что важно не сломать).
- Питание трансиверов: +5V должно оставаться стабильным, иначе порт деградирует по уровню и по помехоустойчивости :contentReference[oaicite:5]{index=5}
- Сигналы управления передачей (TxEn1/TxEn2) являются частью логики порта и не должны “переиспользоваться” без проверки работы протокола :contentReference[oaicite:6]{index=6}

---

### 4.5.2 Ethernet

Назначение.
Ethernet интерфейс реализован на аппаратном контроллере W5500 и подключается к разъёму ETH1.

Состав узла (по схеме).
- U11: W5500 :contentReference[oaicite:7]{index=7}
- Интерфейс к МК: SPI (MOSI, MISO) и сигнал CS_ETH (chip select) :contentReference[oaicite:8]{index=8}:contentReference[oaicite:9]{index=9}
- Сигнал прерывания: INTN :contentReference[oaicite:10]{index=10}
- Индикация линка/активности: LINKLED, ACTLED :contentReference[oaicite:11]{index=11}:contentReference[oaicite:12]{index=12}

Линии к разъёму.
На стороне PHY-линий видны дифференциальные пары:
- TX_P / TX_N (передача)
Также в блоке разъёма ETH1 присутствуют обозначения:
- TD+, TD-, TCT (трансформаторная середина передачи)
- RD+, RD-, RCT (трансформаторная середина приёма)
- CHS GND, Shield (экран/шасси разъёма) :contentReference[oaicite:13]{index=13}

⚠️ Важно.
Наличие “Shield” и “CHS GND” в узле ETH1 означает, что у разъёма есть экран/корпусная точка.
При этом ранее в проектной логике “PE/земля корпуса” не заводилась в устройство (пластик).
В ПЗ это нужно описать как “as-built” и отдельно зафиксировать правило подключения экрана:
- подключён ли Shield к GND напрямую, через RC/феррит, или оставлен NC.
По этому фрагменту видно только наличие выводов, но не видно схему их включения целиком. :contentReference[oaicite:14]{index=14}

Инварианты (что важно не сломать).
- SPI-связь с W5500: MOSI/MISO/CS_ETH/INTN являются инвариантами по распиновке и логике работы :contentReference[oaicite:15]{index=15}:contentReference[oaicite:16]{index=16}
- Согласующие/терминирующие элементы по диффпарам (49.9 Ом и т.п.) и их расположение критичны для качества линка :contentReference[oaicite:17]{index=17}

⚠️ Открытые вопросы (по PDF-видимости).
1) Где именно стоят магнитики (внутри ETH1 или отдельным элементом), и как включены TCT/RCT.
2) Есть ли ESD/TVS защита на Ethernet-линии и на разъёме, и как она подключена к земле/экрану.
Для закрытия нужен полный лист Ethernet (целиком, чтобы видеть весь тракт до разъёма и защит).

---

### 4.5.3 Прочие интерфейсы

В предоставленных фрагментах явно видны SPI-шины для SD и Ethernet.
Другие интерфейсы (USB, UART, I2C, дополнительные SPI, CAN) здесь не описаны.
Их нужно фиксировать по соответствующим листам схемы, чтобы не делать предположений.

⚠️ Открытый вопрос.
Перечислите, какие “внешние” интерфейсы реально выведены на разъёмы (кроме RS-485 и Ethernet),
и на каких разъёмах они находятся.

---

## 4.6 Дискретные и аналоговые цепи

### 4.6.1 Общая роль локальных I/O на плате LCP

Плата LCP является вычислительным и коммуникационным контроллером.
Полевые дискретные и аналоговые сигналы предполагаются в основном через внешние модули по RS-485.
Поэтому на базовой плате “полевые” I/O сведены к минимуму.

На самой плате присутствуют:
- служебные дискретные сигналы (кнопки, индикация),
- служебные измерения (контроль питания, контроль батареи),
- резервные линии МК (ADC и DAC), которые могли быть разведены “на будущее”.

ℹ️ Ниже фиксируется то, что видно по PDF схемы.
Функциональное назначение линий подтверждается только прошивкой и/или таблицей “канал → функция”.

---

### 4.6.2 Аналоговые входы МК (ADC)

В схеме присутствуют сети AD0…AD10 (каналы АЦП SAM3X8E).
Также встречаются AD-линии, совмещённые с другими функциями (например, UART3).

⚠️ Важно.
Часть выводов SAM3X8E мультиплексируется.
Если канал подписан как ADxx и одновременно как TXD/RXD, это означает, что назначение задаётся прошивкой.
Переназначение таких выводов требует согласования со структурой ПО и регрессионной проверки интерфейсов.

Что фиксируем сейчас:
- AD0…AD10 заведены на МК и потенциально доступны для измерений.
- Не подтверждено, используются ли они в изделии и куда физически выведены (TP, разъёмы, внутренние узлы).

⚠️ Открытый вопрос.
Нужна таблица “ADC канал → что измеряет → диапазон → делитель/фильтр → куда выведен (TP/разъём) → используется ли в прошивке”.

---

### 4.6.3 AVREF и качество измерений

На схеме присутствует сеть AVREF и её фильтрация через феррит и конденсатор.
Это типовой подход: отделить аналоговую опору/питание АЦП от шумной цифровой шины.

Что можно утверждать по схеме:
- AVREF имеет локальную фильтрацию.

⚠️ Открытые вопросы.
1) AVREF берётся напрямую от +3V3 или от отдельного источника.
2) Есть ли отдельная “аналоговая земля” (AGND) или всё сведено в общий GND.
3) Есть ли требования по точности и шуму измерений, или это “best effort”.

---

### 4.6.4 Контроль батареи RTC (BatCheck)

В схеме присутствует сигнал BatCheck, заведённый на МК.
Назначение предполагаемое: контроль напряжения батареи CR2032.

⚠️ Открытый вопрос.
Нужен фрагмент схемы, где реализован BatCheck (делитель, фильтр, номиналы).
Нужно также подтвердить логику в прошивке (порог “battery low”, период опроса, реакция).

---

### 4.6.5 Аналоговые выходы (DAC)

В схеме присутствуют сети DAC0 и DAC1 (выводы ЦАП SAM3X8E).
Это означает, что возможность аналогового вывода предусматривалась.

⚠️ Открытый вопрос.
1) Куда идут DAC0/DAC1 (разъём, тест-поинт, внутренний узел).
2) Есть ли обвязка (резистор в серии, RC-фильтр, ОУ-буфер).
3) Допустимая нагрузка и режим использования в прошивке.

---

### 4.6.6 Дискретные цепи на плате (кнопки, индикация, сервис)

По PDF видно наличие кнопки (например, Btn2) и набора статусных сигналов для индикации.
Также видны имена сетей, связанные со статусами подсистем (например, SD_OK, PLC_OK и т.п.).

⚠️ Важно.
По именам сетей нельзя полностью восстановить смысл индикации.
Нужно подтвердить фактическое назначение каждой линии по схеме и прошивке.

⚠️ Открытый вопрос.
Нужен список всех LED и кнопок:
- designator (D/LED), цвет (если известен), имя сети, активный уровень (0/1),
- токоограничение и способ включения (на +3V3 или на GND, через транзистор или напрямую),
- поведение в прошивке (когда горит/мигает и что означает).

---

### 4.6.7 Инварианты (что нежелательно ломать при развитии)

- Имена и назначение сетей ADx, DACx, AVREF, BatCheck должны совпадать между схемой, PCB и прошивкой.
- Любые изменения фильтрации AVREF и распределения земель влияют на шум и точность измерений.
- Любые изменения мультиплексируемых выводов (ADC ↔ UART/PIO) делаются только вместе с изменением прошивки и проверкой интерфейсов.

---

## 4.7 Индикация и органы управления (LED, кнопки, buzzer)

### 4.7.1 Назначение узла индикации

На плате реализован отдельный узел “LED Indication”, который обеспечивает:
- индикацию состояния подсистем (например, SD_OK, PLC_OK),
- индикацию/отладку сигналов управления (линии RTSx, UART_RTS_x),
- индикацию линии X2X (связано с RS-485 / шиной модулей).

Узел построен на светодиодах LED1…LED5 и наборе ключей на BSS138, с токоограничительными резисторами.
Питание индикации выполнено от +5V, управляющие сигналы приходят с логики +3V3 (через транзисторные ключи). :contentReference[oaicite:0]{index=0}

---

### 4.7.2 Светодиоды и связанные сигналы (как “as-built” по схеме)

LED1.
- LED1 подключён к GND (индикация через токоограничение).
- Токоограничение: R64 = 240 Ом. :contentReference[oaicite:1]{index=1}

LED2.
- Токоограничение: R68 = 240 Ом.
- В схеме рядом указаны сигналы UART_RTS_2 и UART_RTS_3, что указывает на использование LED в связке с линиями RTS (индикация/диагностика). :contentReference[oaicite:2]{index=2}

LED3.
- LED3 присутствует как отдельный индикатор с привязкой к GND (номиналы уточняются по схеме в контексте включения). :contentReference[oaicite:3]{index=3}

LED4.
- Связанные сети: SD_OK и PLC_OK (статусные сигналы).
- То есть LED4 относится к индикации “SD/PLC” (точная логика: какой сигнал зажигает, активный уровень, режим мигания — определяется прошивкой/назначением вывода). :contentReference[oaicite:4]{index=4}

LED5.
- Токоограничение: R69 = 240 Ом.
- Доп. резистор в этом узле: R71 = 510 Ом (используется в части цепи управления/ключа). :contentReference[oaicite:5]{index=5}

---

### 4.7.3 Ключи и согласование уровней (BSS138)

В узле используется ряд MOSFET BSS138 (T1…T7).
Назначение: ключевое управление светодиодами и/или согласование уровней управления (логика +3V3 управляет индикацией, запитанной от +5V). :contentReference[oaicite:6]{index=6}

Факты по схеме:
- T4 = BSS138, управляется сигналом RTS4, в цепи присутствует R105 = 510 Ом. :contentReference[oaicite:7]{index=7}
- T6 = BSS138 и T7 = BSS138, связаны с RTS5 и RTS6. :contentReference[oaicite:8]{index=8}
- T2 = BSS138 и T3 = BSS138 (внутренние ключи узла). :contentReference[oaicite:9]{index=9}
- T5 = BSS138, в обвязке есть R108 = 510 Ом и R109 = 510 Ом. :contentReference[oaicite:10]{index=10}
- Также присутствуют резисторы 510 Ом: R65, R67 (часть цепей управления/ключей). :contentReference[oaicite:11]{index=11}
- Вход от логики +3V3, ключ T1 = BSS138, резистор R16 = 1k, сигнал RTS_PC. :contentReference[oaicite:12]{index=12}

---

### 4.7.4 Питание индикации и резисторы подтяжки

В узле явно присутствуют шины питания:
- +5V (питание части цепей индикации и/или анодной стороны LED через резисторы),
- +3V3 (логика управления через ключ T1). :contentReference[oaicite:13]{index=13}

Резисторы 1k в узле: R70, R72, R73, R104, R107, R110 (подтяжки/ограничение токов управления в цепях ключей). :contentReference[oaicite:14]{index=14}

---

### 4.7.5 “Органы управления”: кнопки и buzzer (статус по загруженным файлам)

По тем листам, которые сейчас видны в схеме узла “LEDs.SchDoc”, показана только индикация.
Явных цепей кнопок (BTN) и buzzer/зуммера на этом листе не видно.

⚠️ Открытые вопросы.
1) Есть ли на плате кнопки (например, Reset/User) и на каком листе схемы они нарисованы.
2) Есть ли buzzer (зуммер) и какой у него режим (пищалка/аларм/отладка).

Если кнопки/зуммер существуют в проекте, их нужно описать отдельным подпунктом 4.7.6 по соответствующему листу схемы.

---

### 4.7.6 Инварианты и ограничения (для сопровождения)

- Имена статусных сетей (SD_OK, PLC_OK, X2X_Led, RTS4/RTS5/RTS6, RTS_PC) являются частью “контракта” между железом и прошивкой.
  При переносе на другую ревизию платы или при изменении назначения портов МК это должно изменяться синхронно в ПО и КД. :contentReference[oaicite:15]{index=15}:contentReference[oaicite:16]{index=16}
- Питание индикации от +5V и управление от +3V3 через ключи — это архитектурное решение узла.
  Замена схемы включения LED без проверки может привести к неверным уровням, паразитным токам и ложным индикациям. :contentReference[oaicite:17]{index=17}

---

## 4.8 Отладка и программирование (сервисные интерфейсы)

### 4.8.1 Назначение

На плате предусмотрен сервисный интерфейс для:
- прошивки микроконтроллера ATSAM3X8E через отладчик;
- отладки (breakpoints, чтение памяти/регистров);
- сервисного восстановления платы при проблемах с прошивкой.

---

### 4.8.2 Тип интерфейса и сигналы (по схеме)

По схемам LCP присутствуют JTAG-сигналы:
- JTAG_TMS
- JTAG_TCK
- JTAG_TDI
- JTAG_TDO

Также присутствует линия сброса:
- NRST (MASTER-RESET / NRST, аппаратный reset)

И опорные сигналы:
- GND (земля отладчика/платы)

ℹ️ В схемах этот узел обозначен как “JTAG” (служебный разъём).

⚠️ Важно.
Сервисный разъём является частью ремонтопригодности изделия.
Его нельзя “переиспользовать” под другие функции без проверки, иначе можно потерять возможность прошивки и восстановления платы.

---

### 4.8.3 Рекомендованный порядок подключения (сервис)

1) Плата должна быть запитана штатно, и уровень +3V3 должен быть стабильным.
2) Подключить отладчик к сервисному разъёму, обязательно подключив GND.
3) При проблемах прошивки/связи проверить линию NRST и отсутствие помех по питанию.

⚠️ Риск нестабильной отладки.
Если “земля шкафа” шумная или есть наводки, это может проявляться как:
- случайные reset,
- обрыв сессии отладки,
- ошибки чтения/записи флеш.
В этом случае проверяют питание, GND-подключение, и фронты NRST.

---

### 4.8.4 Инварианты и ограничения

- JTAG-линии и NRST считаются инвариантами аппаратной части.
- Любые изменения этих линий (добавление нагрузки, фильтров, разрывов, переименование сетей) требуют проверки:
  - что отладчик продолжает видеть МК,
  - что возможна прошивка,
  - что не ухудшилась помехоустойчивость.

⛔ Критично.
Если потеряна возможность прошивки через сервисный разъём, восстановление платы может стать невозможным без выпайки/спец. процедур.

---

### 4.8.5 Открытые вопросы (чтобы закрыть раздел полностью)

⚠️ Открытый вопрос.
Для завершения раздела нужен pinout сервисного разъёма (таблица “контакт → сигнал”):
- RefDes разъёма (X?/J? на схеме)
- тип разъёма (шаг, рядность, тип корпуса)
- полный перечень сигналов на контактах (TMS/TCK/TDI/TDO/NRST/GND и т.д.)
- есть ли VTref (опорное питание для отладчика) и к какому уровню оно привязано

⚠️ Открытый вопрос.
Подтвердить режим, который реально использовался в проекте:
- JTAG или SWD (в SAM3X8E возможно оба, но по схеме мы фиксируем только то, что выведено на разъём)

---

## 5.1 Габариты, посадочные, крепёж, разъёмы (механика, ограничения корпуса)

### 5.1.1 Общая конструкция и механические допущения

Плата установлена в пластиковом корпусе.
PE/шасси на плату не заводится. Металлического корпуса с привязкой к земле нет.

⚠️ Открытый вопрос.
Нужны фактические габариты платы (L×W), координаты/диаметр крепёжных отверстий, и ограничения по высоте компонентов.
По одним схемам это корректно не восстановить.

---

### 5.1.2 Разъёмы и посадочные места (перечень по схеме)

X2X (ввод питания и RS-485).
- Тип: 5-контактный клеммник Phoenix Contact, push-in.
- Назначение: +24V/0V питание и линии RS-485 A/B.
- Средний контакт: NC (не используется).
⚠️ Риск: провода в push-in можно перепутать, нужна маркировка распиновки возле разъёма.

ETH1 (Ethernet разъём).
- Назначение: подключение Ethernet.
- По схеме присутствуют контакты Shield/CHS GND (экран разъёма). 
⚠️ Открытый вопрос: как включён Shield (на GND напрямую, через RC/феррит, или NC).
Это важно для ЭМС и для поведения в “пластиковом корпусе”.

SD1 (microSD).
- Назначение: хранение конфигурации на съёмной карте.
- Интерфейс: SPI (MOSI/MISO/SPCK/CS_SD) и SD_Detect.
- Питание: +3V3, есть локальная развязка (0.1 µF), есть подтяжка CS_SD. 
⚠️ Механика: требуется обеспечить доступ к карте (вырез/окно корпуса) и ограничение на “перекос” при вставке.

JTAG / сервисный разъём (отладка/прошивка).
- Назначение: прошивка и отладка МК.
- Линии JTAG присутствуют на схеме (JTAG_TMS/TCK/TDI/TDO), а также NRST. 
⚠️ Открытый вопрос: тип разъёма (шаг, рядность) и точный pinout “контакт → сигнал”.

---

### 5.1.3 Крепёж и посадка платы в корпус

По схемам невозможно восстановить:
- количество крепёжных отверстий;
- их координаты, диаметр, допуски;
- зоны keep-out под стойки/винты;
- допустимые высоты компонентов под крышкой корпуса.

⚠️ Открытый вопрос.
Нужно одно из двух:
1) PCB PDF (Top/Bottom + Mechanical layers), или
2) чертёж платы/корпуса с габаритами и крепежом.

---

### 5.1.4 Ограничения корпуса и зоны доступа

Для корпуса нужно явно зафиксировать механические требования:
- доступ к клеммнику X2X (ввод питания и RS-485),
- доступ к Ethernet (вставка/защёлка RJ45),
- доступ к microSD (если карта обслуживаемая),
- доступ к сервисному разъёму (если допускается сервис без вскрытия корпуса, иначе фиксируем “только при разборке”).

⚠️ Открытый вопрос.
Сервисный разъём JTAG должен быть:
- либо доступен при разборке корпуса (описать порядок),
- либо доступен снаружи через технологическое окно (если так задумано).

---

### 5.1.5 Инварианты (что нельзя ломать при доработках механики)

- Нельзя менять ориентацию и тип посадочных мест разъёмов без проверки совместимости с корпусом и кабелями.
- Нельзя добавлять высокие компоненты в зоне крышки корпуса без проверки высоты.
- Для Ethernet важно корректно обработать экран разъёма (Shield/CHS GND) с учётом пластикового корпуса. 

---

5.3

---




## 5.4 Размещение компонентов и зонирование (тепло, noisy/sensitive зоны, вводы/ESD-зоны)

### 5.4.1 Назначение раздела и границы точности

В этом разделе фиксируется логика размещения компонентов на плате и зонирование по функциям.
Цель: чтобы инженер, сопровождающий изделие, понимал где “шумно”, где “чувствительно”, и что нельзя нарушать при доработках.

⚠️ Ограничение.
По загруженным файлам (схемы, BOM, отчёт БП) можно описать зонирование “по функции”.
Но без PCB (PcbDoc/PCB PDF/Gerber) нельзя подтвердить фактическое расположение, расстояния и ориентации компонентов.
Поэтому ниже даётся “as-designed” по структуре схемы и набору узлов, а “as-built” уточняется по PCB.

---

### 5.4.2 Функциональные зоны платы

Зона A. Ввод питания и силовая часть (PSU, +24V → +5V → +3V3).
Состав:
- входной клеммник питания и линии +24V/0V,
- узел DC/DC buck (TPS54331) и силовые компоненты (диод, дроссель, вход/выходные конденсаторы),
- LDO 3.3V (LM1117-3.3) и его обвязка.

Назначение зоны:
- минимизация петель тока DC/DC,
- локализация тепловыделения (D1/U2/U3),
- короткие связи входных и выходных конденсаторов к силовым выводам.

Зона B. Микроконтроллер и тактирование (MCU + clocks).
Состав:
- ATSAM3X8E,
- кварц 12 MHz и кварц 32.768 kHz,
- цепи reset/JTAG,
- backup домен и батарейная развязка (RTC/VDDBU).

Назначение зоны:
- минимальная длина и аккуратная трассировка кварцев,
- локальная развязка питания МК,
- снижение цифровых помех в окрестности кварцев.

Зона C. Ethernet тракт (W5500 + разъём ETH).
Состав:
- W5500 и SPI к МК,
- цепи TX/RX, согласование/резисторы,
- разъём Ethernet и его Shield/CHS GND.

Назначение зоны:
- сохранение целостности дифференциальных линий TX/RX,
- короткий и прямой тракт от контроллера к разъёму,
- корректная обработка экрана разъёма (Shield) с учётом пластикового корпуса.

Зона D. RS-485 интерфейсы и вводы линии (X2X шина).
Состав:
- один или несколько RS-485 трансиверов,
- цепи управления Tx/Rx/TxEn,
- клеммник/разъёмы A/B.

Назначение зоны:
- локализация “грязных” длинных линий (A/B) у ввода/разъёма,
- минимизация наводок на чувствительные цепи (кварцы, reset, AVREF),
- установка защит (если они есть) максимально близко к разъёму.

Зона E. microSD узел.
Состав:
- держатель microSD,
- линии SPI и CS_SD,
- SD_Detect, локальная развязка.

Назначение зоны:
- короткие линии SPI,
- доступность карты для обслуживания (если предусмотрено),
- минимизация влияния на SPI от силовых импульсных токов.

Зона F. Индикация и органы управления (LED, кнопки).
Состав:
- светодиоды, ключи, токоограничение,
- кнопки (если есть на плате).

Назначение зоны:
- размещение индикаторов в зоне видимости пользователя,
- ограничение помех от длинных линий к индикации.

---

### 5.4.3 Noisy и sensitive зоны

Noisy (источники помех):
- силовая часть DC/DC (U2, D1, L5) и её токовые петли,
- линии Ethernet TX/RX и область около разъёма,
- линии RS-485 A/B и зона ввода внешних кабелей.

Sensitive (чувствительные цепи):
- кварцы 12 MHz и 32.768 kHz и их обвязка,
- reset-линии (NRST/MASTER-RESET),
- AVREF и входы АЦП (если реально используются),
- backup домен VDDBU и цепь батареи.

Правило зонирования:
- noisy зоны держать ближе к краю платы и к соответствующим разъёмам,
- sensitive зоны держать в центре, под экранирующим влиянием земли, вдали от вводов кабелей и силовой части.

---

### 5.4.4 Тепло и рассеяние мощности

Основные источники тепла на плате:
- диод силового контура buck,
- DC/DC микросхема,
- LDO 3.3V при высокой нагрузке (рассеяние ~ (5.0 − 3.3) * I3V3).

Рекомендации “as-designed”:
- обеспечить достаточную медь вокруг силовых компонентов и LDO,
- не размещать кварцы и AVREF рядом с горячими компонентами,
- предусмотреть тепловой запас с учётом температуры внутри шкафа.

⚠️ Открытый вопрос.
Нужны наблюдения по эксплуатации:
- перегревались ли PTC/диод/LDO,
- при каких температурах шкафа и нагрузках,
- есть ли случаи отключения питания из-за нагрева.

---

### 5.4.5 Зоны ввода, ESD и защита разъёмов

Вводы внешних кабелей:
- питание +24V,
- RS-485 A/B,
- Ethernet,
- microSD (как механический интерфейс).

Общее правило:
- защитные элементы (TVS/ESD/ферриты), если предусмотрены, размещать максимально близко к разъёму,
- обеспечить короткий путь в “землю” для импульсных токов ESD.

⚠️ Открытый вопрос.
По текущим данным не подтверждено наличие ESD/TVS на входе +24V и на линиях Ethernet/RS-485.
Если такие элементы есть на других листах/в другой ревизии, нужно добавить их в раздел и привязать к зонам ввода.

---

### 5.4.6 Инварианты (что нельзя ломать при переделке размещения)

- Силовая петля DC/DC (входной конденсатор → ключ → диод/дроссель → выходной конденсатор) должна оставаться минимальной.
- Кварцы и их обвязка не должны пересекаться с noisy-трассами и не должны быть удалены от МК.
- Линии Ethernet TX/RX должны быть парными, симметричными и идти кратчайшим маршрутом до разъёма.
- RS-485 A/B и все защитные/согласующие элементы должны оставаться у разъёма, чтобы снижать наводки.
- Линии reset и JTAG не должны проходить через шумные зоны без необходимости.

---


## 5.5 DFM/DFA: технологичность (допуски, полярности, маркировка, сборочные требования)

### 5.5.1 Назначение раздела и границы точности

Этот раздел фиксирует требования к технологичности изготовления и сборки платы.
Цель: снизить риск ошибок монтажа и ускорить производство и ремонт.

⚠️ Ограничение.
Без PCB-файла и сборочных выходных файлов (assembly drawing, pick&place, gerber) нельзя подтвердить фактические:
- размеры площадок, зазоры, маску, пасту,
- ориентации компонентов на плате,
- оформление сборочного чертежа.
Поэтому ниже даётся “скелет” DFM/DFA требований для этого изделия и список того, что нужно добавить из производственных файлов.

---

### 5.5.2 Критичные элементы по полярности и ориентации

Элементы, где ошибка ориентации приводит к неработоспособности или к повреждению:
- диоды в силовой части (в т.ч. диод защиты от переполюсовки и диод buck-контура),
- TVS (если установлен на +5V или линиях интерфейсов),
- микросхемы питания (buck TPS54331, LDO LM1117-3.3),
- микросхемы интерфейсов (RS-485 трансиверы, W5500),
- батарейный узел RTC (держатель CR2032 и диодная развязка).

Требование:
- на silk-слое обязательно должны быть:
  - обозначение позиции (RefDes),
  - метка 1-го вывода для микросхем,
  - метка катода для диодов,
  - “+” для батареи и/или метка ориентации держателя.

---

### 5.5.3 Маркировка разъёмов и предотвращение ошибок подключения

Разъёмы, где ошибка подключения наиболее вероятна:
- клеммник питания и RS-485 (push-in: провода можно перепутать),
- Ethernet,
- microSD (механический доступ),
- сервисный разъём JTAG (важен pinout и GND).

Требование:
- рядом с разъёмами должна быть читаемая маркировка:
  - назначение контактов (минимум: +24V, 0V, A, B),
  - направление/ориентация разъёма (если применимо),
  - предупреждение, если контакт не используется (NC).

---

### 5.5.4 Корпуса и “технологически чувствительные” компоненты

К типовым технологическим рискам относятся:
- SOT-223 (например, LDO LM1117) — тепловая площадка, вероятность “холодной пайки” при плохом прогреве.
- силовой диод и дроссель DC/DC — массивные элементы, склонны к “tombstoning” и дефектам смачивания при неправильном профиле.
- microSD держатель — механика, качество пайки экрана/лапок, риск отрыва при эксплуатации.
- Ethernet разъём — механические нагрузки, пайка экрана/корпуса, требования к монтажу.

Требование:
- силовые и механически нагруженные элементы должны иметь достаточные площадки и, при необходимости, дополнительные крепёжные точки/лапки по рекомендованному footprint производителя.

---

### 5.5.5 Требования к пайке и пасте (общие, без привязки к конкретному трафарету)

Минимальные требования:
- соблюдать рекомендованный профиль пайки для бессвинцового/свинцового процесса (в зависимости от производства),
- не перегревать plastic разъёмы (microSD, Ethernet) и пластиковые корпуса компонентов,
- контролировать качество пайки на силовых цепях (DC/DC, LDO) и на разъёмах.

⚠️ Открытый вопрос.
Нужен выбор процесса: Pb-free или SnPb, и требования производителя по профилю (если производство их задаёт).

---

### 5.5.6 Сборочный чертёж и Pick&Place (что должно быть в выпуске)

Для DFM/DFA в составе производственного пакета должны быть:
- assembly drawing (top/bottom) с обозначением:
  - RefDes,
  - полярности,
  - меток pin1,
  - опциональных/неустанавливаемых позиций (DNP),
- pick&place файл (centroid) для top и bottom,
- BOM с колонками:
  - RefDes, Qty, MPN, производитель,
  - корпус/footprint,
  - примечания по замене/допускам.

ℹ️ Примечание.
Если BOM ведётся как “инженерный” и “производственный”, в ПЗ полезно явно разделить:
- Engineering BOM (с альтернативами и комментариями),
- Manufacturing BOM (строго под конкретный выпуск).

---

### 5.5.7 Контроль качества сборки (минимальный набор)

Минимум после монтажа:
- визуальный контроль полярности диодов и батареи,
- контроль пайки силовых цепей DC/DC и LDO,
- контроль пайки разъёмов (особенно microSD и Ethernet),
- проверка отсутствия замыканий на силовых шинах (+24V, +5V, +3V3).

---

### 5.5.8 Открытые вопросы для завершения 5.5 “по факту”

⚠️ Открытый вопрос.
Чтобы описать DFM/DFA “as-built”, нужно загрузить хотя бы один из наборов:
1) assembly PDF (top/bottom),
2) pick&place (CSV),
3) gerber/drill,
4) PCB PDF с обозначениями и шелкографией.

Без этих файлов раздел 5.5 остаётся как “общие требования и контрольный список”.

---

## 5.6 Тестируемость (DFT): тест-точки, контрольные измерения, минимальный набор проверок

### 5.6.1 Назначение раздела и границы точности

Цель DFT: обеспечить возможность быстрой проверки платы после сборки и при ремонте.
Минимальная цель: подтвердить, что питание, МК, Ethernet, RS-485 и SD работают в базовом режиме.

⚠️ Ограничение.
По схемам можно определить, какие напряжения и линии нужно проверять.
Но без PCB/assembly-файлов нельзя подтвердить, какие test-point реально предусмотрены, и где они расположены.
Поэтому ниже даётся минимальный набор проверок и список рекомендуемых контрольных точек.

---

### 5.6.2 Рекомендуемые тест-точки (TP) для платы LCP

Питание:
- TP_VIN_24: +24V после разъёма (или после входной защиты, если она есть).
- TP_5V: шина +5V после buck-преобразователя.
- TP_3V3: шина +3V3 после LDO.

Сервисные линии:
- TP_NRST: линия reset (NRST / MASTER-RESET).
- TP_JTAG: доступность сигналов JTAG через разъём (проверка “видит ли отладчик МК”).

Интерфейсы:
- TP_RS485_A / TP_RS485_B: шина A/B около разъёма (или возле трансивера).
- TP_SPI_SCK / TP_SPI_MOSI / TP_SPI_MISO: любая одна SPI-шина (для диагностики активности).
- TP_CS_SD, TP_CS_ETH: chip select линий SD и Ethernet (для подтверждения обращения МК).

ℹ️ Примечание.
Если test-point не разведены, допускается контроль по выводам разъёмов или по ближайшим компонентам (конденсатор питания, резистор в цепи CS).
Но это ухудшает ремонтопригодность.

⚠️ Открытый вопрос.
Подтвердить по PCB, какие TP реально есть (RefDes, доступность щупом/пого-пинами).

---

### 5.6.3 Минимальный набор измерений после сборки (без прошивки)

Шаг 1. Визуальная проверка.
- полярность диодов и батареи;
- ориентация микросхем (pin1);
- отсутствие явных мостов пайки в силовой части и на разъёмах.

Шаг 2. Проверка сопротивлений (перед подачей питания).
- сопротивление между +24V и 0V (нет ли короткого);
- сопротивление между +5V и GND (нет ли короткого);
- сопротивление между +3V3 и GND (нет ли короткого).

Шаг 3. Подача питания +24V с ограничением тока.
- ограничение тока на лабораторном БП (порог зависит от изделия; задаётся как безопасный).
- контролировать ток потребления и отсутствие перегрева.

Шаг 4. Проверка рельсов питания.
- измерить +5V;
- измерить +3V3;
- проверить отсутствие сильных пульсаций на +5V и +3V3 (осциллографом, если есть).

⚠️ Примечание.
Нормы по токам и пульсациям должны быть подтверждены измерениями на эталонной плате.
Сейчас они не зафиксированы в документах, поэтому ниже они вынесены как открытые вопросы.

---

### 5.6.4 Минимальный набор проверок с прошивкой (functional smoke test)

Шаг 1. Проверка запуска МК.
- плата стартует без зависания;
- отсутствуют циклические reset (контроль NRST и поведения индикаторов).

Шаг 2. Проверка Ethernet.
- физический линк поднимается (LINKLED/ACTLED);
- устройство отвечает по сети (например, ping или базовый сервис в прошивке).

Шаг 3. Проверка RS-485.
- порт(ы) RS-485 отвечают на базовый запрос (например, диагностика/эхо/Modbus, если поддерживается).
- линия A/B имеет корректные уровни, нет “залипания” драйвера в передачу.

Шаг 4. Проверка microSD.
- карта определяется;
- чтение конфигурации проходит без ошибок;
- запись (если используется) проходит без ошибок.

ℹ️ Для ускорения теста полезен короткий “factory test mode” в прошивке.
Он должен выдавать статусы по UART или по Ethernet и/или через LED.

---

### 5.6.5 Типовые неисправности и что проверять в первую очередь

1) Плата не стартует.
- проверить +3V3;
- проверить reset (NRST);
- проверить нагрев LDO и DC/DC.

2) Нет Ethernet линка.
- проверить питание W5500 (+3V3);
- проверить разъём и экран (Shield/CHS GND);
- проверить SPI активность (CS_ETH, SCK).

3) Не работает RS-485.
- проверить +5V питания трансиверов;
- проверить TxEn линии;
- проверить уровни на A/B и наличие внешнего оконечивания/нагрузки.

4) SD не определяется.
- проверить +3V3 на SD;
- проверить SD_Detect;
- проверить CS_SD (подтяжка и переключение).

---

### 5.6.6 Открытые вопросы (нужны, чтобы сделать DFT “закрытым” и воспроизводимым)

⚠️ Открытый вопрос.
Нужны измеренные нормы (на эталонной исправной плате):
- ток потребления при 24V в режиме idle;
- ток при активном Ethernet и активном RS-485;
- допустимые пульсации +5V и +3V3 (осциллограммы или численно).

⚠️ Открытый вопрос.
Нужно подтвердить список test-point по PCB:
- RefDes TP, их расположение, доступность, назначение.

⚠️ Открытый вопрос.
Нужно определить “минимальный заводской тест”:
- какой набор команд/признаков подтверждает работоспособность (LED, UART лог, ping, Modbus-опрос).

---

## 5.7 Перечень и назначение производственных файлов (Gerber/ODB++, drill, pick&place, assembly drawing)

### 5.7.1 Назначение раздела и принцип “источник истины”

Этот раздел фиксирует, какие файлы должны входить в производственный релиз платы.
Цель: чтобы сторонний инженер или производство могли воспроизвести изготовление и монтаж без автора.

Источник истины:
- для электрической части: schematics + BOM;
- для производства: набор производственных файлов (Gerber/ODB++, drill, pick&place, assembly, stackup).

⚠️ Ограничение.
В текущих загруженных файлах производственные output-файлы (Gerber/Drill/PnP/Assembly) не предоставлены.
Поэтому ниже приведён “целевой состав релиза” и правила именования.
Когда реальные файлы будут добавлены в репозиторий, этот раздел дополняется конкретными именами и версиями.

---

### 5.7.2 Минимальный набор файлов для производства

1) Gerber или ODB++.
- Назначение: изготовление платы (проводники, маска, шелкография, паста).
- Предпочтение:
  - ODB++ удобен для производства как единый пакет, если производство поддерживает,
  - Gerber остаётся универсальным стандартом.

2) Drill файлы (сверловка).
- Excellon drill (PTH/NPTH).
- Отдельные файлы/таблицы инструментов (tool list), если формируются отдельно.

3) Stackup / fabrication notes.
- количество слоёв, толщина платы, толщина меди, материалы,
- требования к импедансу (если есть),
- требования к маске/шелкографии (цвет, покрытие, RoHS).

4) BOM (производственная).
- RefDes, Qty, MPN, производитель,
- корпус/footprint,
- DNP позиции (если есть),
- допустимые замены (если допускаются).

5) Pick&Place (centroid).
- координаты X/Y, rotation, side (top/bottom),
- привязка нулевой точки и единицы измерения,
- отдельные файлы для top и bottom (если плата двухсторонняя).

6) Assembly drawing (сборочный чертёж).
- отдельные листы top и bottom,
- RefDes, полярности, pin1, ориентации,
- обозначение DNP,
- отметки критичных компонентов (силовая часть, разъёмы, SD, Ethernet).

---

### 5.7.3 Дополнительные файлы (рекомендуется)

1) IPC-356 netlist (или аналог).
- Назначение: электрическая проверка производством, сравнение соединений.

2) 3D / STEP модели.
- плата в STEP, ключевые компоненты,
- полезно для проверки посадки в корпус и коллизий.

3) Test plan (минимальный).
- список контрольных измерений после сборки (см. раздел 5.6),
- критерии “годен/не годен”.

4) Файлы маркировки.
- требования к серийному номеру, ревизии платы, маркировке на silk/стикере.

---

### 5.7.4 Правила именования и версии (рекомендуемый шаблон)

Рекомендуется фиксировать:
- имя изделия: LCP,
- ревизию платы: RevA / RevB,
- дату релиза,
- номер набора (release tag).

Пример структуры:
- /release/LCP_RevA_YYYY-MM-DD/
  - /fabrication/ (Gerber или ODB++, drill, stackup notes)
  - /assembly/ (pick&place, assembly drawing, BOM manufacturing)
  - /test/ (smoke test, контрольные значения)
  - /docs/ (PDF схем, ПЗ, примечания)

---

### 5.7.5 Контроль целостности релиза (минимум)

Перед передачей в производство проверяется:
- Gerber/ODB++ открывается в viewer и соответствует ожиданиям (слои, маска, шелк, паста).
- Drill совпадает с отверстиями (PTH/NPTH).
- Pick&place корректен (координаты, повороты, top/bottom).
- BOM соответствует сборочному чертежу (RefDes, DNP).
- Stackup совпадает с требуемой толщиной и материалами.

---

### 5.7.6 Открытые вопросы для завершения раздела “по факту”

⚠️ Открытый вопрос.
Нужно добавить в репозиторий реальные производственные файлы или ZIP-пакет от Altium:
- Gerber или ODB++,
- drill,
- pick&place,
- assembly PDF,
- stackup notes.

После этого я:
- перечислю конкретные имена файлов,
- зафиксирую версии/ревизию,
- добавлю короткую инструкцию “как открыть и проверить” (viewer + контрольные пункты).

---

## 6. Элементная база и BOM-логика

### 6.1 Принципы выбора компонентов (общие правила для этого изделия)

## 6.1 Принципы выбора компонентов

### 6.1.1 Контекст разработки и подход

Плата разрабатывалась в условиях ограниченного времени и без отдельной команды по схемотехнике.
Основной метод — использование референсных схем и рекомендаций производителей компонентов.

Это означает:
- топологии узлов (buck, LDO, Ethernet, RS-485, кварцы) соответствуют типовым включениям из даташитов;
- номиналы обвязки в большинстве случаев выбраны по рекомендациям производителя, а не “с нуля” расчётами;
- инженерные компромиссы фиксируем как “as-built” (как сделано) и, при необходимости, отдельно отмечаем “как улучшить” как рекомендацию, но не как дефект.

---

### 6.1.2 Общие критерии выбора (design intent)

Критерий 1. Доступность и повторяемость.
Выбирались компоненты, которые:
- массовые и широко доступные;
- имеют понятные аналоги;
- выпускаются в стандартных корпусах.

Критерий 2. Минимизация риска по интерфейсам.
Для связи использовались специализированные микросхемы:
- Ethernet контроллер (W5500) вместо реализации на дискретной PHY/стеке;
- специализированные RS-485 трансиверы (SN65HVD1785D) для работы на “длинных” линиях.

Критерий 3. Простая силовая архитектура.
Питание построено как:
- +24V системы -> buck преобразователь -> +5V,
- +5V -> LDO -> +3V3 для логики.

Цель:
- получить стабильные +3V3 для МК и цифровых узлов;
- оставить +5V как отдельную шину для интерфейсных драйверов и индикации.

Критерий 4. Следование требованиям даташитов по устойчивости.
Для силовых микросхем и LDO соблюдались требования к:
- входным и выходным конденсаторам;
- расположению силовых компонентов (по смыслу, “максимально близко”);
- базовой фильтрации питания.

⚠️ Примечание.
В некоторых узлах используются керамические конденсаторы вместо электролитов.
Это фиксируется как “как сделано”, потому что соответствует референсным рекомендациям производителя для конкретного узла.

---

### 6.1.3 Критерии по механике и обслуживанию

Разъёмы и интерфейсы выбраны так, чтобы:
- обеспечить удобство монтажа в шкафу (клеммник питания/RS-485),
- обеспечить стандартный Ethernet интерфейс,
- иметь съёмный носитель microSD для конфигурации,
- сохранить сервисный доступ через JTAG для прошивки и восстановления.

---

### 6.1.4 Что является “инвариантом” при выборе компонентов

Инварианты — то, что нельзя менять без пересмотра схемы и проверки изделия:

- уровни питания: +24V вход, +5V шина, +3V3 шина
- тип Ethernet контроллера (W5500) без изменения прошивки менять нельзя
- тип интерфейса RS-485 (трансиверы +5V и логика управления TxEn)
- частоты кварцев (12 MHz и 32.768 kHz) и их требования по обвязке
- механика ключевых разъёмов (Ethernet, microSD, клеммники)

⛔ Критично.
Если меняется компонент, который участвует в аппаратно-программном контракте (например, W5500),
то это автоматически требует изменения ПО и повторной валидации функциональности.

---

### 6.1.5 Открытые вопросы (чтобы “приземлить” принцип выбора на конкретный BOM)

⚠️ Открытый вопрос.
Нужно подтвердить по BOM:
- температурные диапазоны ключевых компонентов (commercial/industrial),
- список допустимых замен для критичных позиций,
- какие позиции являются DNP (если есть),
- статус жизненного цикла (EOL/NRND) для ключевых микросхем.

---

## 6.2 Критичные позиции и допустимые замены

### 6.2.1 Назначение раздела

Критичные позиции — это компоненты, которые:
- определяют работоспособность платы,
- влияют на совместимость с прошивкой и внешними устройствами,
- при замене требуют обязательной проверки.

В этом разделе фиксируем:
- что именно считается критичным,
- какие параметры нельзя нарушать,
- что нужно проверять после замены.

---

### 6.2.2 Питание

U2. Buck-преобразователь +24V -> +5V.
- Функция: формирование шины +5V от входного питания +24V.
- Критичность: запуск платы, пульсации, устойчивость при нагрузке, тепловой режим.

Что нельзя нарушать при замене:
- входной диапазон (24V система),
- выход 5.0V (допуск по проекту),
- требуемый ток нагрузки,
- требования к частоте/компенсации и к внешним компонентам (дроссель, диод, конденсаторы).

⚠️ Важно.
Замена buck “на похожий” часто требует изменения обвязки и иногда трассировки.
Это не компонент “поставил аналог и забыл”.

Минимальная проверка после замены:
- +5V уровень под нагрузкой,
- пульсации +5V (осциллограф),
- нагрев силовых элементов,
- стабильность +3V3 (через LDO).

U3. LDO +5V -> +3V3.
- Функция: питание МК и всей цифровой логики +3V3.
- Критичность: стабильность работы МК, Ethernet, SPI.

Что нельзя нарушать при замене:
- 3.3V номинал,
- ток, dropout,
- устойчивость на выбранных выходных ёмкостях (критично для LDO).

Минимальная проверка после замены:
- +3V3 уровень и пульсации,
- старт МК без циклических reset,
- работа Ethernet и SD.

---

### 6.2.3 Микроконтроллер и тактирование

U1. ATSAM3X8E.
- Функция: центральный вычислительный узел.
- Критичность: часть аппаратно-программного контракта.

⛔ Критично.
Замена на другой МК означает переписывание прошивки и, возможно, переразводку.
В рамках поддержания изделия “как есть” МК считается фиксированным.

XTL6. Кварц 12.0 MHz.
- Функция: базовое тактирование МК.
- Критичность: запуск и стабильность системы.

XT1. Кварц 32.768 kHz.
- Функция: RTC/backup домен.

Что нельзя нарушать при замене кварцев:
- частота 1:1,
- нагрузочная ёмкость (CL) и ESR,
- требования к обвязке и трассировке.

Минимальная проверка после замены:
- стабильный старт,
- отсутствие дрейфа RTC (если используется),
- отсутствие сбоев Ethernet/485 при температуре.

---

### 6.2.4 Ethernet

U11. W5500.
- Функция: Ethernet контроллер.
- Связь с МК: SPI (MOSI/MISO/SCK/CS_ETH), INTN, линии индикации (LINKLED/ACTLED).

⛔ Критично.
W5500 — часть аппаратно-программного контракта.
Замена на другой Ethernet-контроллер невозможна без изменения прошивки и тестов.

Что критично при замене “внутри семейства” (если вообще рассматривается):
- питание +3V3, требования к развязке,
- соблюдение SPI уровней и таймингов,
- сохранение цепей к разъёму Ethernet (согласование, магниты, экран).

Минимальная проверка после любых изменений в узле Ethernet:
- линк поднимается,
- обмен по сети стабилен,
- нет зависаний при нагрузке.

---

### 6.2.5 RS-485

U5/U7. SN65HVD1785D (RS-485 transceiver).
- Функция: физический уровень RS-485.
- Питание: +5V.
- Управление направлением: TxEn1/TxEn2 (по схеме).

Что нельзя нарушать при замене:
- питание 5V и уровни логики управления,
- поддерживаемая скорость и fail-safe поведение,
- устойчивость к помехам и перенапряжениям (в зависимости от объекта).

⚠️ Практический риск.
Разные трансиверы ведут себя по-разному при:
- обрыве линии,
- коротком замыкании,
- смещении общего потенциала.
Это может менять поведение всей шины.

Минимальная проверка после замены:
- обмен по RS-485 с типовой нагрузкой и длиной линии,
- отсутствие “залипания” в передаче,
- корректные уровни A/B.

---

### 6.2.6 microSD и хранение конфигурации

SD1. Держатель microSD.
- Функция: механический интерфейс карты и контактная надёжность.

Что нельзя нарушать при замене:
- механическая совместимость (посадочное место, высота, доступ из корпуса),
- наличие SD_Detect (если используется),
- качество фиксации и пайки.

Минимальная проверка:
- детект карты,
- чтение конфигурации при вибрации/шевелении (если применимо),
- стабильность при длительной работе.

---

### 6.2.7 RTC backup питание

B1. CR2032.
D4. BAT54C (диодная развязка).
- Функция: питание backup домена (VDDBU) при отсутствии основного питания.

Что нельзя нарушать:
- отсутствие паразитной подпитки +3V3 от батареи,
- корректная развязка источников питания.

Минимальная проверка:
- RTC сохраняет время при отключении питания (если эта функция используется),
- ток утечки батареи в норме (если измеряется).

---

### 6.2.8 Индикация и ключи

T1…T7. BSS138.
- Функция: ключи/согласование уровней (управление LED, 3.3V -> 5V домен).

Что нельзя нарушать:
- логика активных уровней,
- допустимые токи LED,
- привязка к +5V и управление от +3V3.

Минимальная проверка:
- корректная индикация статусов,
- отсутствие паразитного свечения/ложных статусов.

---

### 6.2.9 Общая политика замены (коротко)

Если меняется критичная позиция, обязательно:
- фиксируем замену в BOM (MPN, производитель, ревизия),
- проводим минимальные проверки из раздела 5.6,
- фиксируем результат (протокол: “заменили → проверили → ок/замечания”).

⚠️ Открытый вопрос.
Нужно определить, допускаются ли “approved alternatives” в BOM официально,
или BOM считается “frozen” под конкретный выпуск платы.

---

## 6.3 Ограничения по жизненному циклу (EOL-риск) и стратегия аналогов

### 6.3.1 Зачем этот раздел

Даже при корректной электрической схеме изделие может стать “невоспроизводимым” из-за:
- снятия компонентов с производства (EOL / NRND),
- дефицита на рынке,
- изменения корпуса/пин-совместимости,
- смены поставщика и качества партии.

Цель раздела:
- заранее выделить позиции с максимальным риском,
- определить стратегию: что заменяем “безболезненно”, а что требует ревизии железа/ПО,
- зафиксировать минимальный регламент действий при замене.

⚠️ Ограничение.
Для “точной” оценки EOL нужна проверка статусов у производителей/дистрибьюторов.
В рамках текущей ПЗ фиксируем не рыночные данные, а инженерную стратегию сопровождения.

---

### 6.3.2 Классификация компонентов по риску замены

Класс A. Аппаратно-программный контракт (замена = изменение ПО).
- Ethernet контроллер W5500.
- Микроконтроллер ATSAM3X8E.

⛔ Критично.
Замена компонентов класса A без изменения прошивки невозможна.
Если компонент класса A становится недоступным, это запускает проект ревизии железа и ПО.

Класс B. Архитектурно критичные, но допускают аналог при пересчёте.
- Buck +24V -> +5V (U2).
- LDO +5V -> +3V3 (U3).
- RS-485 трансиверы (U5/U7).

⚠️ Важно.
Замена в классе B возможна, но требует:
- проверки устойчивости/пульсаций/тепла,
- иногда пересчёта/замены обвязки,
- обязательного функционального теста (раздел 5.6).

Класс C. Компоненты с высокой доступностью и низким риском.
- резисторы/конденсаторы стандартных номиналов,
- MOSFET ключи BSS138 (если без уникальных требований),
- диоды общего применения (при соблюдении параметров).

ℹ️ Для класса C допускается замена на эквивалент при соблюдении:
- корпуса,
- напряжения/тока/мощности,
- температурного диапазона.

Класс D. Механически критичные.
- разъёмы (Ethernet, microSD, клеммники Phoenix),
- держатель батареи CR2032.

⚠️ Важно.
Даже при электрической совместимости замена механических компонентов может:
- не влезть в корпус,
- изменить доступность обслуживания,
- изменить надёжность пайки и механическую прочность.

---

### 6.3.3 Стратегия аналогов (правила сопровождения)

Правило 1. Для критичных позиций держим “Approved Alternatives”.
Для классов A и B рекомендуется иметь в BOM или отдельном документе:
- минимум 1 альтернативу (лучше 2) с указанием условий замены,
- перечень проверок, которые обязателен после замены.

Правило 2. Аналог должен быть “документированным”, а не “похожим”.
Для каждого аналога фиксируем:
- MPN производителя,
- корпус/footprint,
- ключевые параметры, которые должны совпасть,
- что именно нужно перепроверить на плате.

Правило 3. Замена класса A — это новая ревизия изделия.
Если W5500 или ATSAM3X8E недоступны:
- заводится новая ревизия платы (RevX),
- заводится ветка/релиз прошивки,
- обновляется контракт данных и документация.

Правило 4. Замены класса B допускаются в рамках ревизии, но только с тестом.
Если меняется buck/LDO/RS-485:
- фиксируем в BOM как “вариант исполнения” или “alternative installed”,
- прогоняем минимальный DFT/functional тест (раздел 5.6),
- фиксируем результат.

Правило 5. Замены класса D требуют проверки корпуса.
Если меняется разъём/держатель:
- проверяется механическая совместимость,
- проверяется прочность пайки и монтаж в корпус,
- обновляются сборочные чертежи.

---

### 6.3.4 Минимальный регламент при дефиците/замене (пошагово)

Шаг 1. Классифицировать компонент (A/B/C/D).
Шаг 2. Подобрать аналог с параметрическим сравнением.
Шаг 3. Проверить footprint и механическую совместимость.
Шаг 4. Обновить BOM (и, если надо, assembly drawing).
Шаг 5. Собрать 1–3 платы “pilot batch”.
Шаг 6. Прогнать проверки:
- питание (+5V/+3V3, пульсации, нагрев),
- Ethernet (линк + обмен),
- RS-485 (обмен),
- SD (детект/чтение),
- reset/JTAG (восстановление).
Шаг 7. Зафиксировать решение: “approved alternative” или новая ревизия платы.

---

### 6.3.5 Что нужно добавить позже (чтобы раздел стал “закрытым”)

⚠️ Открытые вопросы.
1) Нужен актуальный BOM LCP.csv (версия/дата) и перечень реально установленных MPN.
2) Нужна политика проекта: BOM frozen или допускает approved alternatives.
3) Желательно: таблица критичных компонентов с колонками:
   - RefDes / MPN / класс риска (A/B/C/D) / approved alternative / комментарий / обязательные проверки.

---

## 6.4 Правила параметрических замен (что считать эквивалентом)

### 6.4.1 Назначение

Этот пункт задаёт единые критерии: когда компонент можно заменить “параметрически эквивалентным” без переделки схемы,
а когда замена автоматически означает новую ревизию платы/ПО.

Принцип:
- эквивалент = совпадает функция + соблюдены критичные параметры + совместим корпус/посадочное + пройдены проверки (раздел 5.6).

---

### 6.4.2 Общие правила эквивалентности (для всех компонентов)

Чтобы считать замену допустимой, должны одновременно выполняться условия:

1) Функция 1:1.
- компонент выполняет ту же роль в схеме (не “похоже”, а именно то же назначение).

2) Корпус и footprint совместимы.
- предпочтительно pin-to-pin и footprint-to-footprint 1:1,
- если корпус тот же, но footprint требует коррекции — это уже ревизия PCB.

3) Номинальные и предельные параметры не хуже.
- напряжение, ток, мощность, температура, дерейтинг.

4) Электрический “контракт” не нарушен.
- уровни логики, тайминги, активные уровни, требования к подтяжкам,
- для интерфейсных ИС — совместимость протокольного/физического уровня.

5) Стабильность/устойчивость подтверждена.
- для стабилизаторов: устойчивость на существующих конденсаторах,
- для аналоговых цепей: шум/дрейф не ухудшены.

6) Пройдены минимальные тесты.
- DFT + функциональный smoke test из раздела 5.6.

---

### 6.4.3 Пассивные элементы (R, C, L)

Резисторы.
Эквивалент, если:
- сопротивление и допуск (например, 1%, 5%) не хуже,
- мощность не ниже,
- напряжение на резисторе не превышает rating,
- корпус тот же или совместим по посадочному (0603 -> 0603 и т.д.).

Конденсаторы.
Эквивалент, если:
- номинал и допуск не хуже,
- напряжение rating не ниже,
- тип диэлектрика и стабильность допустимы для узла (X7R/X5R/NP0),
- ESR/ESL и ток пульсаций подходят для конкретного узла.

⚠️ Важно для питания.
Замена выходных/входных конденсаторов у buck/LDO влияет на устойчивость.
Эквивалентность задаётся не только ёмкостью, но и ESR/типом/диэлектриком.

Дроссели/ферриты.
Эквивалент, если:
- индуктивность/импеданс по частоте соответствует роли (силовой дроссель ≠ феррит),
- ток насыщения и DC resistance не хуже,
- температурный режим не хуже,
- корпус и посадочное совместимы.

---

### 6.4.4 Диоды (в т.ч. защитные и силовые)

Эквивалент, если:
- тип диода соответствует роли:
  - Шоттки/быстрый/обычный,
  - TVS (однонаправленный/двунаправленный),
- Vr (обратное напряжение) не ниже требуемого,
- If (средний ток) и импульсные параметры не хуже,
- Vf и тепловой режим допустимы,
- корпус/посадочное совместимы,
- полярность и маркировка понятны для монтажа.

⚠️ Для TVS важно:
- рабочее напряжение (VRWM),
- уровень клэмпа при импульсе,
- импульсная мощность (8/20, 10/1000), если это задано.

---

### 6.4.5 Стабилизаторы и преобразователи питания (buck, LDO)

Buck (например, +24V -> +5V).
Эквивалент “без переделки схемы” допускается только если:
- pin-to-pin совместимость и тот же корпус,
- та же топология и близкая частота/компенсация,
- требования к внешним компонентам совпадают (дроссель, диод, конденсаторы),
- гарантирована устойчивость на существующих ёмкостях и ESR.

⚠️ Практически.
Для buck эквивалентность редко бывает “drop-in”.
Чаще это новая ревизия обвязки и иногда PCB.

LDO (например, +5V -> +3V3).
Эквивалент, если:
- pin-to-pin и корпус совместимы,
- выход 3.3V и ток нагрузки обеспечены,
- dropout не хуже,
- стабильность на существующих выходных конденсаторах гарантируется даташитом.

---

### 6.4.6 Цифровые микросхемы и интерфейсы (МК, Ethernet, RS-485)

Микроконтроллер.
- Эквивалентность практически отсутствует.
- Замена МК = новая ревизия железа и переписывание ПО.

Ethernet контроллер W5500.
- Эквивалентность отсутствует на уровне “замена без ПО”.
- Замена = изменение прошивки и, как правило, схемы/PCB.

RS-485 трансивер.
Эквивалент, если:
- питание то же (5V),
- pin-to-pin совместимость (или переразводка не требуется),
- логические уровни Rx/Tx/DE/RE совместимы,
- скорость, fail-safe, драйв/защиты не хуже,
- поведение при обрыве/коротком соответствует требованиям системы.

⚠️ Важно.
Разные трансиверы могут по-разному вести себя при смещении общего потенциала и при помехах.
Это нужно учитывать как “критерий эквивалентности” для объекта применения.

---

### 6.4.7 Кварцы и резонаторы

Эквивалент, если:
- частота совпадает 1:1,
- CL совпадает (или корректируется обвязка),
- ESR не хуже требований запуска,
- корпус совместим,
- производитель/серия не ухудшает запуск при температуре.

⚠️ Риск.
Даже при совпадении частоты возможны проблемы запуска, если ESR/CL отличаются.
После замены требуется проверка старта и стабильности.

---

### 6.4.8 Разъёмы и механика

Эквивалент, если:
- посадочное место и механические размеры 1:1,
- высота и ориентация совместимы с корпусом,
- усилие вставки/фиксация не ухудшены,
- для Ethernet: экран/Shield выводы и их механика совпадают.

⚠️ Практически.
Разъёмы часто являются “механически критичными”.
Любая замена требует проверки сборки в корпус и сборочного чертежа.

---

### 6.4.9 Минимальный протокол подтверждения эквивалентности

Для любой параметрической замены фиксируем:
- RefDes, исходный MPN -> новый MPN,
- обоснование (какие параметры совпали),
- что проверили (пункты из 5.6),
- результат (“approved / not approved”),
- дата и ответственное лицо.

---

### 6.4.10 Открытые вопросы (для доведения до “закрытого” регламента)

⚠️ Нужно определить, в каком виде вы хотите хранить правила замен:
- прямо в BOM (колонки Alternative/Approved),
- отдельный документ “Approved Alternatives.md”,
- или таблица в Приложении ПЗ.

⚠️ Нужно подтвердить, какие узлы считаются “безусловно фиксированными” (МК, W5500 и т.д.) для данного контракта.

---


## 7. Встроенные функции, влияющие на аппаратную часть

### 7.1 Режимы загрузки и обновления (bootloader, линии boot, защита от “окирпичивания”)

### 7.1.1 Назначение раздела и границы фактов

Этот раздел описывает аппаратные условия, которые влияют на:
- запуск микроконтроллера (reset, тактирование, питание),
- возможность прошивки/обновления,
- восстановление платы при сбое прошивки.

⚠️ Ограничение.
По схемам можно зафиксировать аппаратные линии JTAG и reset, а также наличие батарейного домена RTC.
Но наличие/тип bootloader и “политика обновления” (по Ethernet/RS-485/SD) подтверждаются только прошивкой и проектной документацией ПО.

---

### 7.1.2 Аппаратные условия загрузки МК

Микроконтроллер: ATSAM3X8E.
Аппаратные факторы, влияющие на загрузку:
- питание +3V3 (основная логика),
- тактирование: кварц 12.0 MHz,
- линия аппаратного сброса NRST (MASTER-RESET / NRST).

NRST.
- NRST выведен как отдельная сеть и используется как аппаратный reset.
- NRST также задействован в сервисных операциях (прошивка/отладка через JTAG). 

Инвариант:
- линия NRST должна оставаться доступной и не должна быть перегружена внешними цепями без проверки старта и отладки.

⚠️ Открытый вопрос.
Есть ли на плате отдельная кнопка Reset (или только тестовая точка/сервисный доступ).
Если кнопка есть — на каком листе схемы она нарисована.

---

### 7.1.3 Сервисное программирование и восстановление (JTAG)

На плате присутствуют линии JTAG:
- JTAG_TMS
- JTAG_TCK
- JTAG_TDI
- JTAG_TDO

Назначение:
- загрузка/перепрошивка через отладчик,
- восстановление платы при повреждении ПО.

⛔ Критично.
Наличие JTAG — основной механизм “анти-окирпичивания” на аппаратном уровне.
Если потеряна возможность программирования через JTAG, восстановление может стать невозможным без сложных процедур.

⚠️ Открытый вопрос.
Нужен точный pinout сервисного разъёма (контакт → сигнал) и тип разъёма (шаг/рядность).

---

### 7.1.4 Bootloader / режимы обновления (что известно и что нужно подтвердить)

Возможные варианты обновления, которые могут быть реализованы в изделии:
- через JTAG (гарантированный сервисный путь),
- через SD (если прошивка умеет обновляться с карты),
- через Ethernet (если реализован сетевой загрузчик),
- через RS-485 (если реализована загрузка по линии модулей).

⚠️ Важно.
По текущим схемам нельзя утверждать, что обновление по SD/Ethernet/RS-485 реализовано.
Схема показывает наличие SD и Ethernet, но это не равно наличию bootloader.

⚠️ Открытые вопросы (нужны факты из прошивки/документации ПО).
1) Есть ли bootloader как отдельный режим (да/нет).
2) По какому интерфейсу выполняется обновление (JTAG / SD / Ethernet / RS-485).
3) Есть ли защита от отката/проверка подписи/CRC.
4) Что происходит при сбое обновления (fallback, safe mode, блокировка).

---

### 7.1.5 Защита от “окирпичивания” (минимальный аппаратный уровень)

То, что уже есть на аппаратном уровне:
- сервисный путь прошивки через JTAG,
- аппаратный reset (NRST),
- стабильное питание +3V3 и разделение доменов (в т.ч. батарейный домен для RTC).

Минимальные рекомендации для сопровождения (если будут доработки ПО/железа):
- иметь “safe recovery” сценарий: если основной образ повреждён, должен оставаться хотя бы один гарантированный путь прошивки (JTAG).
- при разработке обновления по SD/Ethernet предусматривать проверку целостности образа (CRC) до перезаписи основного.

---

### 7.1.6 Что мне нужно от вас, чтобы сделать 7.1 завершённым

⚠️ Нужны факты по прошивке:
1) Как обновляли устройство в реальной эксплуатации (только JTAG или ещё SD/Ethernet/RS-485).
2) Есть ли отдельный bootloader раздел и какой объём памяти он занимает.
3) Есть ли контроль целостности (CRC/подпись).
4) Есть ли процедура “восстановления” для техподдержки (пошагово).

---

### 7.2 Аппаратные таймеры / сторожевой таймер (watchdog) и реакция на сбои питания

### 7.2.1 Назначение раздела и границы фактов

Этот раздел описывает аппаратные возможности, которые влияют на устойчивость работы:
- watchdog и его аппаратные особенности,
- реакция на провалы питания и некорректный старт,
- поведение при reset (ручной, watchdog, brown-out).

⚠️ Ограничение.
По загруженным документам видно аппаратную линию NRST и архитектуру питания (+24V -> +5V -> +3V3),
но конкретная логика watchdog/brown-out задаётся настройками МК и прошивкой.
Поэтому ниже фиксируется “аппаратная база” и перечень данных, которые нужно подтвердить по ПО.

---

### 7.2.2 Аппаратная база: reset и стабильность питания

Линия аппаратного сброса.
- На плате присутствует сеть NRST (MASTER-RESET / NRST).
- NRST используется как аппаратный reset МК и является частью сервисного контура (JTAG/прошивка).

Инвариант:
- NRST должна оставаться доступной и не должна быть нагружена или “зафильтрована” без проверки устойчивости запуска и отладки.

Питание.
- Основной домен цифровой логики питается от +3V3 (формируется через LDO от +5V, а +5V от buck с +24V).
- При нестабильности +3V3 возможны: зависания, ложные reset, некорректное выполнение кода, деградация интерфейсов.

Практическое следствие:
- реакция на провалы питания зависит от:
  - качества +5V/+3V3 (пульсации/просадки),
  - настроек brown-out в МК,
  - наличия/отсутствия внешнего supervisor (по текущим данным отдельного supervisor не зафиксировано).

⚠️ Открытый вопрос.
Есть ли отдельный внешний reset supervisor (например, MCPxxx/ADMxxx) или reset обеспечивается только МК и RC/обвязкой.
Это нужно подтвердить по полным листам схемы.

---

### 7.2.3 Watchdog: что фиксируем на уровне железа

ATSAM3X8E аппаратно поддерживает watchdog (WDT).
С точки зрения железа важно:
- watchdog использует внутренние ресурсы МК,
- внешних элементов для WDT обычно не требуется,
- итоговое поведение зависит от прошивки (включён/выключен, таймаут, режим reset/interrupt).

Что можно фиксировать в ПЗ на уровне аппаратной части:
- плата имеет сервисный reset (NRST) и гарантированный путь восстановления (JTAG),
- watchdog (если включён в ПО) должен приводить к аппаратному reset и перезапуску системы при зависании.

⚠️ Открытый вопрос.
Нужно подтвердить по прошивке:
1) watchdog включён в штатной конфигурации или нет;
2) таймаут (порядок секунд);
3) что считается “нормальным обслуживанием” WDT (где и как feed);
4) причина reset диагностируется ли (лог/флаг reset-cause).

---

### 7.2.4 Brown-out / реакция на провалы питания

Возможные сценарии:
- кратковременная просадка +24V (шумный БП шкафа, броски нагрузки),
- просадка +5V на buck,
- просадка +3V3 на LDO при нагреве/перегрузке.

Риски:
- частичный старт (МК стартует, но периферия/интерфейсы нет),
- зависание на периферии (Ethernet/SD),
- повторяющиеся reset (oscillating reset), если пороги brown-out не согласованы с фронтом питания.

Рекомендуемая политика (на уровне требований к изделию):
- при провале питания система должна уйти в reset и корректно перезапуститься;
- после перезапуска должна быть диагностика причины (если реализовано ПО).

⚠️ Открытые вопросы.
Для завершения раздела нужно:
1) зафиксировать в прошивке настройки brown-out (включён/выключен, порог);
2) есть ли логика “запрета старта” при низком питании (обычно через BOR);
3) есть ли “задержка старта” или внешняя RC-цепь reset.

---

### 7.2.5 Типовые практические проверки (для поддержки)

Минимальные проверки при жалобе “плата перезагружается / виснет”:
- измерить +3V3 (просадки, пульсации, нагрев LDO),
- измерить +5V (просадки, пульсации),
- проверить NRST (нет ли помех/ложных импульсов),
- посмотреть, есть ли корреляция с нагрузкой по Ethernet/RS-485/SD,
- если есть доступ к логам: смотреть reset-cause (WDT/BOR/External reset).

ℹ️ Это связывает раздел 7.2 с разделом 5.6 (DFT и диагностические измерения).

---

### 7.2.6 Что мне нужно от вас, чтобы 7.2 стал “закрытым” (без предположений)

⚠️ Нужны факты по ПО и/или исходникам:
1) watchdog включён по умолчанию? какой таймаут?
2) как фиксируется причина reset (register reset-cause, лог, статусные флаги)?
3) включён ли brown-out и какой порог?
4) есть ли отдельный supervisor/RC reset кроме NRST?

---

### 7.3 Аппаратно-зависимые параметры ПО (частоты, уровни, распиновка, таблицы)

### 7.3.1 Назначение раздела

Этот раздел фиксирует “контракт” между железом и прошивкой:
- какие аппаратные ресурсы МК используются и как (пины, порты, периферия),
- какие уровни питания и логики подразумеваются,
- какие частоты и источники тактирования выбраны,
- какие таблицы/структуры данных завязаны на аппаратную конфигурацию.

Цель: чтобы при развитии платы или прошивки не “сломать совместимость” молча.

---

### 7.3.2 Питание и уровни логики (инварианты)

Инвариант питания цифровой логики:
- основной домен логики: +3V3 (МК ATSAM3X8E, W5500, SD логика).
- домен +5V используется для отдельных узлов (например, RS-485 трансиверы и часть индикации).

Инвариант уровней:
- управляющие сигналы от МК — 3.3V логика.
- интерфейсные драйверы, питаемые от +5V, должны корректно воспринимать 3.3V уровни (или иметь согласование уровней в схеме).

⚠️ Открытый вопрос.
Нужно подтвердить по схеме:
- все ли RS-485 трансиверы принимают 3.3V как “лог.1” при питании 5V (обычно да, но важно фиксировать по даташиту выбранной ИС).
- есть ли где-то явный level-shifting кроме узла LED.

---

### 7.3.3 Тактирование и частоты

В схеме предусмотрено:
- основной кварц 12.0 MHz для МК,
- кварц 32.768 kHz для RTC/low-power домена.

Инварианты:
- частота 12 MHz является базой для настройки PLL/системной частоты МК (зависит от прошивки).
- 32.768 kHz определяет точность RTC (если RTC используется).

⚠️ Открытый вопрос.
Нужно зафиксировать “как в прошивке настроены частоты”:
- частота CPU (MCK) и PLL конфигурация,
- частоты периферии (SPI, UART, таймеры), если они завязаны на PLL.

---

### 7.3.4 Назначение выводов МК (pin mapping)

На плате задействованы аппаратные интерфейсы:
- SPI к W5500 (Ethernet) и к microSD (линии MOSI/MISO/SCK + отдельные CS),
- линии управления RS-485 (TxEn, TXD/RXD),
- сервисные линии JTAG и NRST,
- линии индикации (SD_OK, PLC_OK, RTSx и др.),
- (возможные) ADC/DAC линии (AD0…AD10, DAC0/DAC1).

Инвариант:
- распиновка и имена сетей являются частью контракта.
- любые изменения распиновки = изменение прошивки + регрессионные тесты.

⚠️ Открытый вопрос.
Нужна таблица “MCU pin map”:
- сигнал (имя сети) → порт/пин МК → функция периферии → примечание (активный уровень, pull-up, скорость).

Без этой таблицы раздел 7.3 остаётся декларативным.

---

### 7.3.5 Аппаратно-зависимые параметры протоколов/драйверов

Ethernet (W5500).
Аппаратная зависимость:
- выбран конкретный контроллер W5500,
- драйвер в прошивке завязан на SPI и на выводы CS/INT/RESET (если есть).

RS-485.
Аппаратная зависимость:
- количество портов и линии управления направлением (TxEn),
- параметры UART (baudrate, parity, stop bits) задаются в прошивке и должны соответствовать объекту применения.

microSD.
Аппаратная зависимость:
- CS_SD и SD_Detect,
- SPI-частота и тайминги завязаны на настройку тактирования МК.

Инвариант:
- если меняются частоты SPI/UART (из-за изменения PLL/кварца), могут измениться тайминги обмена.
- при ревизии платы нужно сохранять совместимость или фиксировать изменение как “breaking change”.

---

### 7.3.6 Таблицы и структуры данных, завязанные на железо

К типичным аппаратно-зависимым таблицам в прошивке относятся:
- таблица pin mapping (GPIO init),
- таблица устройств/ID (если есть модульная система),
- таблица каналов/статусов (например, какие LED соответствуют каким статусам),
- параметры питания/датчиков (если используются ADC каналы).

⚠️ Открытый вопрос.
Нужно подтвердить, где хранится “контракт данных”:
- в исходниках прошивки (файлы .h/.c),
- в отдельном документе,
- в структуре JSON конфигурации.

Если есть заголовочный файл с идентификаторами устройств и структурами обмена (например, IGAS_STRUCT_2.h),
его можно вынести в приложение и сослаться на конкретную версию.

---

### 7.3.7 Минимальный “контракт совместимости” (что фиксируем обязательно)

Обязательные инварианты:
1) +3V3 домен для МК/W5500/SD.
2) кварцы 12 MHz и 32.768 kHz (если RTC используется).
3) SPI линии и CS для W5500 и SD.
4) RS-485 UART линии и TxEn.
5) NRST и JTAG как сервисный путь восстановления.
6) имена статусных линий индикации (SD_OK, PLC_OK и т.п.) и активные уровни.

---

### 7.3.8 Что нужно от вас, чтобы раздел 7.3 стал “закрытым” и полезным

⚠️ Нужны конкретные данные из прошивки/репозитория:
1) таблица pin mapping (или список define/инициализаций портов),
2) настройки частот (PLL/MCK), частоты SPI/UART,
3) список интерфейсов и их параметры по умолчанию (baudrate/parity),
4) “контракт данных” для модулей (если есть: ID устройств, структуры пакетов).

---

### 8.1 Карта разъёмов: pinout, направление, уровни, защита, назначение

Цель: зафиксировать “физический контракт” платы LCP — какие разъёмы есть, что на них выведено и какие ограничения по уровням/защите.
Это ключевой раздел для сопровождения и развития изделия без автора.

⚠️ Ограничение.
Точную таблицу pinout (контакт → сигнал) корректно делать по схемам + PCB/assembly (silk часто содержит маркировку).
Сейчас часть данных есть из схем/описания, часть остаётся открытой.

---

#### 8.1.1 Разъём X2X (ввод питания + шина RS-485 модулей)

Назначение:
- вход питания контроллера: +24V и 0V (возврат),
- подключение шины RS-485 для внешних модулей: линии A и B.

Тип:
- клеммник Phoenix Contact, 5 контактов, push-in.

Уровни:
- питание: +24V DC (номинал), допуск задаётся блоком питания шкафа,
- RS-485: дифференциальная линия A/B (физический уровень трансивера на плате).

Особенности механики/монтажа:
- клеммник физически не переворачивается, но провода в push-in можно перепутать.
- требуется маркировка над разъёмом: где +24V, где 0V, где A/B.

Особенности “земля/корпус”:
- корпус пластиковый, PE на плату не заводится.
- средний контакт разъёма ранее предполагался как PE/земля, но в текущем исполнении не используется (NC).

Защита:
- на входе питания применяется самовосстанавливающийся предохранитель (PTC) и диод защиты от переполюсовки (по вашей вводной).
- TVS на входе +24V отсутствует (по вашей правке).

⚠️ Открытый вопрос.
Нужна точная таблица pinout X2X (контакт 1..5 → назначение) по схеме/шелкографии.

---

#### 8.1.2 Ethernet разъём (ETH)

Назначение:
- сетевое подключение контроллера.

Аппаратная реализация:
- Ethernet контроллер W5500 внутри платы,
- наружу выведен стандартный Ethernet порт (RJ45).

Уровни:
- наружу: стандартный Ethernet интерфейс на разъёме,
- внутренняя логика: W5500 питается от +3V3 и общается с МК по SPI.

Экран/Shield:
- на схеме присутствуют контакты Shield/CHS GND (экран разъёма).

⚠️ Открытый вопрос (критично для ЭМС).
Как включён Shield:
- напрямую на GND,
- через RC/феррит,
- или оставлен NC.
Для пластикового корпуса это особенно важно (поведение по помехам/наводкам).

Защита:
- наличие ESD-защиты на линиях Ethernet нужно подтвердить по схеме (на текущих данных явно не зафиксировано).

---

#### 8.1.3 microSD разъём (SD1)

Назначение:
- хранение конфигурации на съёмной карте.

Интерфейс:
- SPI: MOSI/MISO/SCK,
- CS_SD (chip select),
- SD_Detect (датчик вставки).

Уровни:
- питание SD узла: +3V3.

Особенности:
- требуется обеспечить механический доступ карты (окно/вырез корпуса), если карта обслуживаемая.
- стабильность работы зависит от качества контакта, механики держателя и устойчивости SPI.

⚠️ Открытый вопрос.
Нужно подтвердить режим использования:
- карта только для чтения (конфигурация),
- или используется запись (логирование/обновление).

---

#### 8.1.4 Сервисный разъём JTAG (отладка/прошивка)

Назначение:
- прошивка и отладка ATSAM3X8E,
- восстановление платы при сбое ПО.

Сигналы (по схемам/нашим разделам):
- JTAG_TMS, JTAG_TCK, JTAG_TDI, JTAG_TDO,
- NRST (аппаратный reset),
- GND.

Инвариант:
- сервисный доступ через JTAG считается обязательным механизмом восстановления.
- нельзя удалять/переиспользовать эти линии без перепроверки возможности прошивки.

⚠️ Открытый вопрос.
Нужны:
- тип разъёма (шаг, рядность, тип корпуса),
- полный pinout “контакт → сигнал” (таблица).

---

#### 8.1.5 Рекомендованная таблица, которую нужно добавить в финальной версии

Формат таблицы pinout для каждого разъёма:
- Разъём / Контакт / Сигнал / Направление (IN/OUT/BI) / Уровень (24V/5V/3V3/RS-485) / Защита (PTC/диод/ESD/none) / Комментарий.

⚠️ Чтобы заполнить таблицу без предположений, нужны:
- полный PDF схем (все листы) или
- список разъёмов из BOM + их refdes + assembly/PCB PDF с шелкографией.

---

### 8.2 Протоколы: что поддерживается, ограничения

Цель: зафиксировать “протокольный контракт” изделия LCP:
- какие протоколы заявлены/поддерживаются,
- на каких физических интерфейсах они доступны (Ethernet / RS-485),
- какие есть ограничения (режимы, таймауты, количество соединений),
- как версия прошивки влияет на поддержку.

⚠️ Ограничение.
Электрическая схема показывает наличие Ethernet (W5500) и RS-485, но не подтверждает, какие протоколы реально реализованы в прошивке конкретной версии.
Факт поддержки протокола подтверждается:
- версией прошивки,
- документацией протокола (карта регистров/ASDU),
- тестами на эталонной плате.

---

#### 8.2.1 Заявленные протоколы (по продуктовой рамке LCP)

В рамках изделия LCP заявлялись следующие протоколы:
- Modbus RTU (обычно по RS-485).
- Modbus TCP (по Ethernet).
- IEC 60870-5-104 (по Ethernet).

⚠️ Открытый вопрос.
Нужно подтвердить, какие из этих протоколов реально включены в текущем релизе прошивки, который передаётся покупателю.

---

#### 8.2.2 Привязка протоколов к физическим интерфейсам

Ethernet (через W5500).
- Тип интерфейса: Ethernet контроллер W5500, связь с МК по SPI.
- Протоколы, которые могут быть поверх Ethernet:
  - Modbus TCP,
  - IEC 60870-5-104,
  - служебные сервисы (если реализованы: web/udp/diagnostic).

RS-485.
- Физический уровень: RS-485 трансиверы, линии A/B на разъёме X2X.
- Протоколы, которые могут быть поверх RS-485:
  - Modbus RTU,
  - внутренний протокол обмена с модулями (если используется отдельный “шинный” протокол).

⚠️ Открытый вопрос.
Нужно разделить:
1) “RS-485 для модулей” (внутренний протокол/шина),
2) “RS-485 для внешнего устройства” (Modbus RTU),
если на изделии это разные порты или разные режимы.

---

#### 8.2.3 Режимы работы (master/slave/server/client)

Для каждого протокола должны быть зафиксированы режимы:

Modbus RTU:
- устройство работает как slave или как master (или оба режима)?
- какие функции Modbus поддерживаются (03/04/06/16 и т.п.)?

Modbus TCP:
- устройство выступает как server (slave) на определённом TCP-порту?
- допускается ли несколько клиентов одновременно?

IEC 60870-5-104:
- устройство выступает как controlled station (server) или controlling station (client)?
- поддерживается ли несколько master-подключений?

⚠️ Открытый вопрос.
Без информации из прошивки нельзя корректно утверждать режимы.

---

#### 8.2.4 Параметры по умолчанию (обязательны к фиксации)

Для воспроизводимости эксплуатации нужно зафиксировать дефолтные значения:

Для RS-485 (Modbus RTU или шинный протокол):
- baudrate,
- parity,
- stop bits,
- slave address (если Modbus),
- таймауты (ответ/межкадровый).

Для Ethernet:
- IP режим (DHCP/static),
- TCP-порты сервисов:
  - Modbus TCP (обычно 502),
  - IEC-104 (обычно 2404),
  - прочие (если есть),
- таймауты соединений,
- ограничения по количеству сессий.

⚠️ Открытый вопрос.
Эти параметры обычно задаются конфигурацией (SD/Flash) и прошивкой.
Нужны фактические дефолты и где они хранятся.

---

#### 8.2.5 Ограничения и “границы применимости”

Типовые ограничения, которые нужно явно указать (по факту реализации):
- максимальное число одновременных TCP соединений (ограничение W5500 и стека ПО),
- максимальная частота опроса/обмена (зависит от циклов прошивки),
- размеры буферов пакетов,
- таймауты и поведение при потере связи.

⚠️ Открытый вопрос.
Нужно подтвердить:
- используемое число сокетов W5500 (сколько задействовано),
- поведение при переполнении (drop/retry),
- поведение при disconnect/reconnect.

---

#### 8.2.6 Минимальные тесты протоколов (для приемки и поддержки)

Modbus RTU:
- тест чтения/записи минимального набора регистров,
- проверка устойчивости при “шумной” линии.

Modbus TCP:
- подключение 1 клиента, чтение/запись,
- подключение 2 клиентов (если поддерживается),
- проверка reconnect после обрыва.

IEC-104:
- установление соединения,
- обмен базовыми ASDU (по фактической реализации),
- устойчивость при reconnect.

ℹ️ Эти тесты связываются с разделом 9.1 (типовые проверки) и могут быть оформлены как “смоук-тест протоколов”.

---

#### 8.2.7 Что нужно от вас, чтобы 8.2 стал “закрытым” и без предположений

⚠️ Нужны факты из прошивки/документации:
1) перечень реализованных протоколов в релизе, который передаётся покупателю;
2) режимы работы каждого протокола (server/client, master/slave);
3) параметры по умолчанию (RS-485 скорость/паритет/адреса; Ethernet IP/порты);
4) ограничения (сокеты W5500, кол-во клиентов, таймауты);
5) ссылки на документы:
   - Modbus: карта регистров,
   - IEC-104: перечень ASDU/IOA,
   - RS-485 шинный протокол модулей: структура кадров и ID устройств (если есть).

---

### 8.3 Модель данных / структуры обмена (ссылки на исходники, версии структур)

Цель: зафиксировать “контракт данных” — какие структуры, идентификаторы и правила обмена считаются стабильными,
чтобы при развитии изделия не ломалась совместимость между:
- контроллером LCP,
- периферийными модулями/устройствами,
- верхним уровнем (SCADA/HMI/конфигуратор).

⚠️ Принцип.
В этом разделе не пытаемся “переписать протокол словами”.
Мы фиксируем:
1) где лежит источник истины (файлы в репозитории),
2) какие версии этих структур существуют,
3) какие изменения считаются breaking change,
4) какие тесты подтверждают совместимость.

---

#### 8.3.1 Источники истины (где хранится контракт)

Контракт данных должен быть привязан к конкретным артефактам проекта:
- заголовочные файлы прошивки (*.h) со структурами пакетов, ID устройств, таблицами каналов;
- (если есть) документация протокола в Markdown/PDF (карта регистров, описание ASDU);
- (если есть) спецификация JSON конфигурации (схема/примеры).

Рекомендуемая практика для Git:
- файл(ы) контракта данных лежат в репозитории в отдельной папке, например:
  - /protocol/
  - /docs/protocol/
  - /firmware/include/protocol/
- в ПЗ даётся ссылка на путь + тег/коммит релиза.

⚠️ Открытый вопрос.
Нужно уточнить, какие конкретно файлы являются “контрактом” в вашем проекте:
- по RS-485 модулям: структуры кадров, ID устройств;
- по Ethernet протоколам: карта регистров Modbus, перечень ASDU/IOA IEC-104;
- по конфигурации: JSON-структуры.

---

#### 8.3.2 Состав контракта данных (что обязательно фиксировать)

Минимальные компоненты контракта:

A) Идентификаторы устройств и модулей.
- список ID (числовые коды),
- человекочитаемые имена,
- правила расширения (как добавлять новый ID без конфликта).

B) Структуры пакетов и их поля.
- порядок и типы полей (uint8/uint16/float и т.п.),
- endianess (если актуально),
- выравнивание/packing (если C-структуры уходят “как есть”),
- CRC/контроль целостности (если используется).

C) Модель каналов/переменных.
- список параметров, их типы и единицы,
- правила масштабирования (если есть),
- формат передачи статусов/ошибок.

D) Версионирование.
- версия протокола (major/minor),
- правила обратной совместимости:
  - minor: добавляем поля/каналы без ломки,
  - major: ломаем формат и меняем версию явно.

---

#### 8.3.3 Версионирование: как фиксируем изменения

Рекомендуемая схема версий:
- PROTO_VER_MAJOR — ломающее изменение (breaking).
- PROTO_VER_MINOR — добавление совместимое назад.

Правила:
- добавление нового поля в середину структуры = почти всегда breaking (если парсер не поддерживает TLV).
- добавление нового поля в конец структуры может быть совместимым, если:
  - в пакете есть длина,
  - получатель игнорирует хвост.
- изменение типа/масштаба существующего поля = breaking.
- переиспользование старого ID под другое устройство = breaking (запрещено).

---

#### 8.3.4 Контракт для Modbus (если используется)

Если Modbus (RTU/TCP) является частью продукта:
- источник истины: карта регистров (документ + версия).
- для каждого регистра фиксируются:
  - адрес,
  - тип (uint16/uint32/float, signed/unsigned),
  - масштаб/единицы,
  - доступ (RO/RW),
  - поведение при записи (применение сразу/после перезапуска).

⚠️ Открытый вопрос.
Нужна фактическая карта регистров (или ссылка на файл в репозитории).

---

#### 8.3.5 Контракт для IEC-104 (если используется)

Если IEC 60870-5-104 поддерживается:
- источник истины: перечень ASDU/IOA (документ + версия).
- фиксируем:
  - какие ASDU реализованы,
  - какие типы измерений/команд,
  - какие IOA соответствуют каким переменным,
  - качества (QDS), время (CP56Time2a) — если используется.

⚠️ Открытый вопрос.
Нужен фактический перечень ASDU/IOA (или ссылка на файл).

---

#### 8.3.6 Контракт обмена с модулями по RS-485 (если есть отдельная “шинная” модель)

Если RS-485 используется как внутренняя шина модулей:
- источник истины: структуры кадров и таблица “ID устройства → тип устройства → набор каналов”.
- фиксируем:
  - формат кадра (адресация, длина, payload, CRC),
  - требования к таймингам (межкадровые паузы, таймаут ответа),
  - правила обнаружения модулей/инициализации.

⚠️ Открытый вопрос.
Нужны:
- структура кадра (C-структура или документ),
- список ID модулей и их “карта каналов”.

---

#### 8.3.7 Минимальные тесты совместимости (что проверяем при изменениях)

Чтобы изменение протокола не “ломало поле”, вводится регресс:
- тест на совместимость старой версии устройства с новой прошивкой,
- тест на совместимость нового модуля со старой прошивкой (если требуется),
- тесты parsing/serialization (unit-tests), если есть.

Минимум для практики:
- эталонные “golden frames” (несколько пакетов в hex/JSON) для каждой версии протокола,
- автоматическая проверка “декодируется → совпадает модель данных”.

---

#### 8.3.8 Что нужно от вас, чтобы 8.3 стал “закрытым”

⚠️ Нужны конкретные ссылки на артефакты:
1) файл(ы) *.h со структурами и ID (путь в репозитории или загрузить сюда);
2) документ(ы) карты регистров Modbus (если есть);
3) документ(ы) ASDU/IOA для IEC-104 (если есть);
4) описание/пример JSON конфигурации (если это часть контракта).

После этого я:
- вставлю в 8.3 точные ссылки (имя файла, версия, где лежит),
- сформирую таблицу “Версия контракта → что изменилось → совместимость”,
- добавлю минимальный чеклист “как вводить изменение без ломки”.

---

## 9. Контроль, настройка, сервис

### 9.1 Типовые проверки после сборки (питания, токи, осциллограммы)

Цель: дать воспроизводимый минимальный регламент проверки платы LCP после монтажа и перед установкой в корпус/шкаф.
Проверки делятся на:
- электрические (без прошивки),
- функциональные (с прошивкой).

⚠️ Ограничение.
Численные нормы по токам/пульсациям должны быть подтверждены измерениями на эталонной плате.
Пока нормы не зафиксированы — в тексте оставлены как открытые поля.

---

#### 9.1.1 Подготовка к проверке

Оборудование (минимум):
- лабораторный блок питания 0…30V с ограничением тока,
- мультиметр,
- (желательно) осциллограф,
- (желательно) термометр/тепловизор,
- Ethernet кабель + ПК,
- адаптер RS-485 (USB-RS485) для связи.

Подготовка платы:
- визуальный осмотр (см. 5.5): полярности, pin1, качество пайки силовых цепей и разъёмов.
- проверка отсутствия металлических стружек/остатков флюса в зоне разъёмов и под микросхемами.

---

#### 9.1.2 Электрические проверки ДО подачи питания

1) Проверка сопротивлений (контроль на короткое).
- +24V ↔ 0V (на входе).
- +5V ↔ GND.
- +3V3 ↔ GND.

Критерий:
- отсутствие “почти нуля” (явного КЗ).
⚠️ Открытый вопрос.
Нужно определить типовые значения/диапазоны для исправной платы (для статистики ремонта).

---

#### 9.1.3 Подача питания (первый запуск) с ограничением тока

Шаг 1.
Подать +24V на вход (X2X), ограничив ток лабораторным БП.

Рекомендуемая процедура:
- начать с низкого лимита тока,
- постепенно повышать лимит до значения, при котором плата стартует стабильно.

⚠️ Открытый вопрос.
Нужно указать целевой ток потребления:
- I_idle при старте,
- I_work при активном Ethernet/RS-485.

Шаг 2.
Проверить отсутствие перегрева.
- пальцем/термометром: buck, диод, LDO 3.3V, PTC (если есть).

Критерий:
- компоненты не должны выходить в неадекватный нагрев на холостом ходе.

---

#### 9.1.4 Контроль напряжений питания (обязательный минимум)

Проверить:
- +24V на входе (факт подачи),
- +5V на выходе buck,
- +3V3 на выходе LDO.

Критерий:
- +5V в допуске,
- +3V3 в допуске,
- отсутствуют просадки при базовой работе (индикация/ethernet link и т.п.).

⚠️ Открытый вопрос.
Указать допустимые диапазоны (+5V и +3V3) и точки измерения (TP/RefDes).

---

#### 9.1.5 Осциллограммы (желательно, но не всегда обязательно)

Если доступен осциллограф, снять:
- пульсации на +5V (buck ripple),
- пульсации на +3V3 (после LDO),
- линию NRST (нет ли ложных импульсов reset).

Критерий:
- пульсации в допустимых пределах (зафиксировать по эталону),
- NRST стабилен (нет дребезга/паразитных reset).

⚠️ Открытый вопрос.
Нужны эталонные осциллограммы или численные пределы (мВpp) для +5V/+3V3.

---

#### 9.1.6 Функциональные проверки с прошивкой (smoke test)

Ethernet.
- проверить, что линк поднимается (LED на разъёме/плата),
- проверить доступность устройства в сети (ping или диагностический сервис).

RS-485.
- проверить обмен по RS-485 (Modbus RTU или внутренний протокол, в зависимости от прошивки),
- убедиться, что драйвер не “залипает” в передачу.

microSD.
- вставить карту,
- проверить детект (если используется),
- проверить чтение конфигурации (и запись, если применимо).

Сервис.
- при необходимости: проверить доступ по JTAG (МК определяется отладчиком).

Критерий:
- устройство проходит базовый набор проверок без зависаний и циклических reset.

⚠️ Открытый вопрос.
Нужно зафиксировать “официальный” минимальный сценарий теста для релиза:
- какие команды/программы используются,
- какие признаки считаются PASS/FAIL.

---

#### 9.1.7 Результат проверки (что фиксировать в протоколе)

Рекомендуемый минимальный протокол на плату:
- серийный номер / ревизия платы,
- дата,
- входное напряжение и установленный лимит тока,
- измеренные +5V и +3V3,
- ток потребления (idle/work),
- результат тестов Ethernet/RS-485/SD,
- замечания (нагрев, нестабильность, дефекты монтажа).

---

### 9.2 Поиск неисправностей по симптомам
(таблица: симптом → вероятная причина → проверка)

Цель: дать сервисному инженеру быстрый маршрут диагностики без “разборов полётов”.
Формат: симптом → вероятные причины (в порядке частоты) → что измерить/проверить → ожидаемый результат.

⚠️ Примечание.
Пункты ниже — “скелет” по архитектуре платы (питание, МК, Ethernet, RS-485, SD, индикация).
После того как вы дадите:
- эталонные токи/напряжения,
- фактические test-point (TP),
мы добавим конкретные значения и позиции на плате.

---

#### 9.2.1 Симптом: плата не включается (нет признаков жизни)

Вероятные причины:
1) Нет входного +24V или переполюсовка на клеммнике.
2) Сработал/неисправен PTC (если установлен) или цепь входной защиты.
3) Не запускается buck (+5V нет).
4) Не запускается LDO (+3V3 нет).

Проверки:
- измерить +24V на входе (на разъёме и после входной цепи).
- измерить +5V (после buck).
- измерить +3V3 (после LDO).
- проверить нагрев PTC/диода/buck/LDO.

Ожидаемый результат:
- при исправной плате +5V и +3V3 появляются быстро и стабильны.

---

#### 9.2.2 Симптом: плата включается, но “подвисает” или уходит в циклический reset

Вероятные причины:
1) Просадки/пульсации по +3V3 (перегрузка, нагрев LDO, дефект конденсаторов).
2) Просадки по +5V (buck уходит в защиту/неустойчивость).
3) Помехи/наводки на NRST (ложные reset).
4) Watchdog/BOR срабатывает из-за питания или ошибки ПО.

Проверки:
- осциллограф: +5V ripple, +3V3 ripple.
- осциллограф: линия NRST (нет ли импульсов).
- измерить ток потребления: прыгает ли/растёт ли до срабатывания защиты.
- если есть лог/статус: проверить причину reset (WDT/BOR/External).

Ожидаемый результат:
- на исправной плате NRST стабилен, питания без провалов.

---

#### 9.2.3 Симптом: нет связи по Ethernet (линка нет)

Вероятные причины:
1) Нет питания +3V3 на W5500 или плохая развязка.
2) Ошибка пайки разъёма Ethernet / плохой контакт.
3) Проблема с трактом TX/RX (согласование/обвязка/паяные дефекты).
4) Shield/экран разъёма подключён некорректно и “ловит” помехи (контекст пластикового корпуса).
5) ПО не инициализирует W5500.

Проверки:
- измерить +3V3 на питании W5500.
- проверить наличие активности по SPI (SCK/CS_ETH) при старте.
- проверить линк на другом кабеле/порту/свитче.
- визуально проверить пайку разъёма и его экрана.
- если есть возможность: опросить W5500 по SPI (диагностическая команда/лог).

Ожидаемый результат:
- линк появляется при подключении исправного кабеля и корректной инициализации.

---

#### 9.2.4 Симптом: линк есть, но сетевой обмен нестабилен / пропадает связь

Вероятные причины:
1) Питание +3V3 шумное/просаживается под нагрузкой.
2) SPI тайминги/частоты некорректны (завязка на PLL/частоту МК).
3) Конфликт сокетов/ресурсов W5500 (ограничения по соединениям).
4) Ошибка ПО или зависание без корректного восстановления.

Проверки:
- осциллограф: +3V3 ripple при сетевой нагрузке.
- проверить конфигурацию сети (IP/DHCP/порт) и число одновременных клиентов.
- проверить повторяемость: “падает через N минут/при N соединениях”.
- если есть: снять лог/диагностику по состоянию сокетов.

Ожидаемый результат:
- связь стабильна при типовой нагрузке и числе соединений в пределах реализации.

---

#### 9.2.5 Симптом: RS-485 не работает (нет ответа/ошибки связи)

Вероятные причины:
1) Нет +5V питания на RS-485 трансиверах.
2) Ошибка управления направлением (TxEn): драйвер всегда в Tx или всегда в Rx.
3) Перепутаны линии A/B на клеммнике.
4) Нет общей “0V” связи между устройствами (смещение потенциала) или сильные помехи.
5) Неправильные параметры порта (baud/parity/addr) в конфигурации/ПО.

Проверки:
- измерить +5V на трансивере.
- осциллограф/логика: проверить TxEn при попытке передачи.
- поменять местами A/B (как диагностический приём, если допускается).
- проверить параметры порта (baud/parity/address).
- проверить наличие 0V (reference) между устройствами.

Ожидаемый результат:
- при корректных параметрах и подключении обмен идёт устойчиво.

---

#### 9.2.6 Симптом: RS-485 иногда работает, но с ошибками (CRC/таймауты)

Вероятные причины:
1) Помехи на линии или плохая топология (длина, ветвления).
2) Неправильное оконечивание/подтяжки (если используются).
3) Смещение общего потенциала между устройствами (нет reference).
4) Перегрузка по протоколу (слишком частый обмен, маленькие таймауты).

Проверки:
- снизить скорость/увеличить таймауты — меняется ли стабильность.
- проверить кабель, длину, наличие оконечивания на концах.
- измерить уровни на A/B и посмотреть форму сигнала осциллографом.
- проверить токи/нагрев трансивера (перегрузка/короткое).

Ожидаемый результат:
- при правильной топологии и настройках ошибки исчезают.

---

#### 9.2.7 Симптом: microSD не определяется

Вероятные причины:
1) Нет +3V3 на разъёме SD или плохая развязка.
2) Проблемы пайки держателя microSD.
3) Некорректный CS_SD / SD_Detect (подтяжки, активный уровень).
4) Слишком высокая частота SPI или проблемы с сигналами.
5) Карта несовместима (формат/файловая система/контакт).

Проверки:
- измерить +3V3 на SD.
- проверить SD_Detect (логический уровень при вставке/извлечении).
- осциллограф: активность SPI при обращении.
- проверить другой картой (заведомо рабочей).
- проверить форматирование карты (по требованиям прошивки).

Ожидаемый результат:
- карта определяется и читается в типовом формате.

---

#### 9.2.8 Симптом: индикация LED неправильная / “фантомное” свечение

Вероятные причины:
1) Неправильные активные уровни в прошивке (конфликт pin mapping).
2) Ошибка пайки MOSFET ключей/резисторов.
3) Перепутаны линии управления (ошибка разводки/ревизии).
4) Паразитные токи через подтяжки/соседние цепи.

Проверки:
- проверить соответствие прошивки pin mapping конкретной ревизии платы.
- измерить уровни на управляющих линиях LED.
- проверить номиналы токоограничительных резисторов.

Ожидаемый результат:
- статусы соответствуют реальным состояниям (SD OK, PLC OK, LINK/ACT и т.п.).

---

#### 9.2.9 Симптом: греется питание / отключается питание при “жарко в шкафу”

Вероятные причины:
1) Перегрев LDO 3.3V (рассеяние мощности).
2) Перегрев PTC (если стоит в цепи питания) из-за нагрузки или внешних помех.
3) Buck работает на грани по току/температуре.
4) Плохой теплоотвод на плате (мало меди, плохая вентиляция корпуса).

Проверки:
- тепловизор: определить самый горячий компонент.
- измерить ток потребления и напряжения +5V/+3V3 при нагреве.
- проверить деградацию при повышенной температуре (прогрев феном/камера, аккуратно).

Ожидаемый результат:
- при штатной нагрузке устройство не должно уходить в защиту в допустимом диапазоне температур.

⚠️ Открытый вопрос.
Нужны:
- фактические жалобы/кейсы,
- типовые токи нагрузки,
- условия по температуре и вентиляции корпуса.

---

#### 9.2.10 Что нужно добавить, чтобы таблица стала “закрытой”

⚠️ Нужны конкретные данные:
1) список тест-точек (RefDes TP) и их назначение,
2) эталонные значения: I_idle, I_work, допустимые диапазоны +5V/+3V3,
3) активные уровни ключевых сигналов (TxEn, CS_SD, CS_ETH, SD_Detect, PLC_OK/SD_OK),
4) привязка симптомов к логам/статусам ПО (если есть).

---

### 9.3 Рекомендации по доработкам
(что можно менять без пересчёта/испытаний, а что нельзя)

Цель: дать сопровождающему инженеру практическую матрицу изменений:
- какие правки считаются “безопасными” (minor change),
- какие требуют обязательной перепроверки (major change),
- какие автоматически означают новую ревизию платы/ПО (breaking change).

⚠️ Принцип.
Мы документируем изделие “как есть” (as-built).
Рекомендации ниже — это регламент сопровождения, а не критика решений 10-летней давности.

---

#### 9.3.1 Категории изменений

Категория A. Безопасные изменения (минимальный риск).
- не меняют функциональную схему,
- не меняют аппаратно-программный контракт,
- выполняются в рамках той же ревизии платы (без переразводки).

Категория B. Изменения со средней критичностью.
- могут менять устойчивость питания, ЭМС, поведение интерфейсов,
- требуют обязательного DFT + функциональных тестов (раздел 9.1 / 5.6),
- обычно допустимы в той же ревизии при аккуратной замене, но решение фиксируется.

Категория C. Ломающие изменения (breaking change).
- меняют контракт железо↔ПО, распиновку, базовую архитектуру,
- требуют новой ревизии платы и, как правило, изменения прошивки.

---

#### 9.3.2 Что можно менять (Категория A)

Пассивные элементы в некритичных цепях.
- резисторы и конденсаторы, не влияющие на стабильность DC/DC/LDO, тактирование, интерфейсы.
Условия:
- номинал/допуск/мощность не хуже,
- корпус совместим,
- соблюдены правила 6.4 (эквивалентность).

LED и их токоограничительные резисторы (в рамках допустимых токов).
Условия:
- не превышать ток/мощность,
- сохранить логику активных уровней.

Винты/крепёж/мелкая механика (при неизменном корпусе и посадке).

---

#### 9.3.3 Что можно менять, но только с проверкой (Категория B)

Питание.
- замена buck/LDO на аналоги,
- замена входных/выходных конденсаторов в узлах питания,
- изменения в цепях защиты по питанию (PTC/диоды).

Требуется:
- измерение +5V/+3V3 под нагрузкой,
- осциллограммы пульсаций,
- контроль нагрева,
- функциональный тест Ethernet/RS-485/SD.

RS-485 узел.
- замена трансиверов на аналоги,
- изменение подтяжек/оконечивания (если есть),
- изменения ESD/защитных элементов на линии.

Требуется:
- тест обмена на типовой линии,
- проверка устойчивости при помехах/длине.

Ethernet тракт (без смены W5500).
- изменение обвязки разъёма/экрана/ESD,
- изменения разводки в зоне разъёма (если это ревизия PCB).

Требуется:
- проверка линка и стабильности обмена,
- проверка при “шумных” условиях (если актуально).

microSD узел.
- замена держателя, подтяжек, SD_Detect логики,
- изменения частот SPI (через прошивку).

Требуется:
- детект карты, чтение конфигурации,
- тест на стабильность контакта.

---

#### 9.3.4 Что нельзя менять без новой ревизии платы/ПО (Категория C)

МК ATSAM3X8E.
- замена на другой МК = новая архитектура ПО и железа.

Ethernet контроллер W5500.
- замена на другой контроллер = изменение прошивки, возможно изменение схемы/PCB.

Распиновка интерфейсов (pin mapping).
- перенос SPI/UART/CS/TxEn/индикации на другие пины = изменение прошивки и тестов.

Тактирование (частоты кварцев 12 MHz / 32.768 kHz).
- изменение частоты = пересчёт PLL/таймингов, риск несовместимости интерфейсов.

Архитектура питания.
- смена уровней +5V/+3V3,
- изменение power-tree,
- изменение доменов питания интерфейсов.

Механически критичные разъёмы, если меняется посадка/высота.
- Ethernet, microSD, клеммники, JTAG, батарейный держатель — любые изменения требуют проверки корпуса и сборочного процесса.

---

#### 9.3.5 Минимальный регламент при любых изменениях (чтобы не потерять контроль)

1) Зафиксировать изменение в BOM и в истории ревизий (что поменяли, почему).
2) Классифицировать изменение (A/B/C).
3) Для B/C — обязательно выполнить:
   - измерения питания (+5V, +3V3),
   - контроль нагрева,
   - функциональные тесты (Ethernet, RS-485, SD),
   - (если затронут reset/такты) — проверка JTAG и стабильности старта.
4) Зафиксировать результат (PASS/FAIL) и приложить измерения/осциллограммы.

---

#### 9.3.6 Практические “узкие места”, где лучше не экспериментировать

- узел питания (buck + LDO): устойчивость и тепловой режим,
- включение Shield Ethernet в пластике (ЭМС/наводки),
- RS-485 без reference/земли между устройствами (риск нестабильности),
- кварцы и их обвязка (риск нестарта и дрейфа).

Это не запреты, а зоны, где любое изменение должно считаться Категорией B или C.

---

#### 9.3.7 Открытые вопросы (что уточнить для финального выпуска)

⚠️ Нужно уточнить:
1) есть ли зафиксированный диапазон температуры/условий эксплуатации (для оценки перегрева LDO/PTC);
2) какие протоколы реально включены в релизе прошивки (для тест-матрицы изменений);
3) какие “approved alternatives” уже применялись на практике (по истории производства).

---


## 10. Заключение

### 10.1 Ключевые ограничения и инварианты (итоговый список)

Цель: в одном месте собрать “что нельзя ломать”, чтобы инженер сопровождения мог быстро оценить риск любой правки.

---

#### 10.1.1 Инварианты питания (power-tree)

1) Вход питания изделия: +24V DC (шкафной БП), возврат 0V.
2) На плате формируются:
   - +5V (buck от +24V),
   - +3V3 (LDO от +5V).
3) Домены питания:
   - +3V3 питает МК ATSAM3X8E, W5500, SD и прочую цифровую логику.
   - +5V используется для RS-485 трансиверов и индикации (и/или узлов, которые так спроектированы).

Инвариант:
- смена уровней +5V/+3V3 или их источников = архитектурное изменение (breaking, новая ревизия).

---

#### 10.1.2 Инварианты аппаратно-программного контракта (HW↔SW)

1) МК: ATSAM3X8E — фиксирован для данного изделия.
2) Ethernet: W5500 — фиксирован как часть контракта (без смены ПО не заменяется).
3) Тактирование:
   - кварц 12.0 MHz (база PLL и таймингов),
   - кварц 32.768 kHz (RTC, если используется).
4) Распиновка МК и назначение сигналов (pin mapping) — часть контракта.
   - изменение пинов SPI/UART/CS/TxEn/LED = изменение прошивки и тестов.

Инвариант:
- любые изменения в пунктах 1–4 считаются breaking change и требуют новой ревизии платы/ПО.

---

#### 10.1.3 Инварианты интерфейсов и разъёмов

1) X2X: ввод питания +24V и шина RS-485 (A/B) для модулей.
   - PE/земля на плату не заведена (корпус пластиковый).
2) Ethernet разъём: стандартный сетевой порт, реализация через W5500.
   - схема включения Shield (экран) критична для ЭМС и должна быть фиксирована/проверена при изменениях.
3) microSD: хранение/чтение конфигурации (SPI, CS_SD, SD_Detect).
4) JTAG + NRST: сервисный путь прошивки/восстановления (анти-окирпичивание).

Инвариант:
- механика и pinout разъёмов должны оставаться совместимыми (иначе это новая ревизия корпуса/PCB/документации).

---

#### 10.1.4 Инварианты по сопровождению и производству

1) BOM фиксируется как часть релиза.
   - критичные позиции должны иметь правила замен (раздел 6.4).
2) Любая замена критичных узлов (питание, RS-485, Ethernet тракт, SD) требует тестов:
   - питание (+5V/+3V3, пульсации, нагрев),
   - функциональный smoke test (Ethernet/RS-485/SD),
   - при необходимости проверка JTAG/NRST.
3) “Единственный источник истины” по производству — релизный пакет (Gerber/ODB++, drill, pick&place, assembly, stackup).

---

#### 10.1.5 Короткий чеклист “можно ли менять?”

- Можно (низкий риск): пассивы в некритичных цепях, LED при соблюдении токов, типовые расходники.
- Можно, но только с тестом: buck/LDO/конденсаторы питания, RS-485 трансиверы, SD держатель, включение Shield/ESD.
- Нельзя без новой ревизии/ПО: ATSAM3X8E, W5500, частоты кварцев, pin mapping интерфейсов, архитектура питания.

---

### 10.2 Риски при изменениях и минимальный план валидации после модификации

Цель: дать практический “минимум испытаний”, который нужно выполнить после любых аппаратных изменений,
чтобы не выпустить в поле нестабильную ревизию.

---

#### 10.2.1 Основные риски при изменениях (по категориям узлов)

Питание (+24V -> +5V -> +3V3).
Риски:
- неустойчивость buck/LDO (осцилляции),
- рост пульсаций и срывы Ethernet/SD,
- перегрев (LDO, buck, PTC),
- циклический reset из-за провалов питания.

Ethernet (W5500 + разъём/Shield).
Риски:
- линк не поднимается из-за обвязки/пайки,
- нестабильный обмен из-за шума питания или SPI таймингов,
- деградация ЭМС из-за неправильного включения Shield в пластиковом корпусе.

RS-485.
Риски:
- несовместимость логических уровней/TxEn,
- деградация устойчивости на длинных линиях,
- проблемы из-за отсутствия reference/0V между устройствами,
- ошибки CRC/таймауты при помехах.

microSD.
Риски:
- плохой контакт держателя,
- нестабильность SPI при частоте/длинах линий,
- некорректная работа SD_Detect или CS_SD,
- проблемы чтения конфигурации (формат/тайминги).

Тактирование/Reset.
Риски:
- нестарты из-за кварца/обвязки,
- ложные reset по NRST,
- сбои таймингов периферии при изменении PLL/частоты.

Механика (разъёмы/корпус).
Риски:
- не влезает в корпус,
- нарушена доступность microSD,
- нагрузка на пайку разъёмов (ломается в эксплуатации).

---

#### 10.2.2 Классификация изменений и объём валидации

Категория A (низкий риск).
Примеры: некритичные пассивы, LED в рамках токов.
Валидация:
- визуальный контроль,
- базовая проверка питания (+5V/+3V3),
- короткий функциональный smoke test.

Категория B (средний риск).
Примеры: buck/LDO, конденсаторы питания, RS-485 трансиверы, SD держатель, Shield/ESD.
Валидация:
- полный минимальный план (см. 10.2.3),
- термоконтроль,
- тест обмена на интерфейсах.

Категория C (breaking change).
Примеры: МК, W5500, кварцы/частоты, pin mapping, архитектура питания.
Валидация:
- полный план + расширенные тесты,
- обновление документации/контрактов,
- новая ревизия платы и прошивки.

---

#### 10.2.3 Минимальный план валидации (обязательный набор)

Этап 1. “Безопасный старт” (электрика до функционала).
1) Проверка на короткое (омметром):
   - +24V↔0V, +5V↔GND, +3V3↔GND.
2) Первый запуск с лабораторного БП:
   - +24V, ограничение тока.
3) Измерить напряжения:
   - +5V, +3V3 (в покое).
4) Контроль нагрева (через 3–5 минут):
   - buck, LDO, PTC, диоды.

Критерий PASS:
- напряжения в допуске,
- нет перегрева/ухода в защиту.

Этап 2. “Качество питания” (осциллограммы).
5) Осциллограф:
   - ripple +5V (buck),
   - ripple +3V3 (после LDO),
   - NRST (нет ложных импульсов).
Критерий PASS:
- пульсации и поведение reset не хуже эталона (нормы фиксируются по рабочей плате).

Этап 3. “Функциональный smoke test” интерфейсов.
6) Ethernet:
   - линк поднимается,
   - обмен (ping/тестовый сервис/Modbus TCP/IEC-104 — по факту прошивки).
7) RS-485:
   - базовый обмен (Modbus RTU или шинный протокол),
   - проверка, что TxEn работает корректно (нет “залипания” в Tx).
8) microSD:
   - детект карты,
   - чтение конфигурации (и запись, если используется).
9) Сервис:
   - проверка JTAG доступности (если это критично для поставки/поддержки).

Критерий PASS:
- всё проходит без зависаний/перезапусков, повторяемо в нескольких циклах питания.

Этап 4. “Стресс и границы”.
10) Перезапуски:
   - минимум 10 циклов power-cycle (включение/выключение).
11) Нагрузка:
   - Ethernet обмен + параллельно RS-485, наблюдение стабильности.
12) Температура:
   - прогрев до “условий шкафа” (если актуально) и повтор smoke test.

Критерий PASS:
- нет деградации при прогреве и нагрузке.

---

#### 10.2.4 Что фиксировать в отчёте по модификации

Для каждой модификации фиксируется:
- что изменили (RefDes/MPN/Rev),
- категория (A/B/C),
- результаты измерений:
  - +5V/+3V3, ток потребления,
  - осциллограммы ripple,
  - температура критичных элементов,
- результаты smoke test (Ethernet/RS-485/SD),
- вывод: APPROVED / NOT APPROVED.

---

#### 10.2.5 Открытые поля (нужно заполнить по эталонной плате)

⚠️ Чтобы план стал “закрытым”, нужны численные нормы:
- допустимые диапазоны +5V и +3V3,
- допустимые пульсации (мВpp) по +5V и +3V3,
- типовые токи потребления (idle/work),
- допустимые температуры (или “не выше X°C корпуса компонента”).

После того как вы дадите 1–2 набора измерений с рабочей платы, я вставлю нормы в текст.

---


Приложения
А. Структурная схема (рисунок)
B. Дерево питания (схема/таблица)
C. Таблица разъёмов (pinout)
D. Таблица напряжений и контрольных точек (TP map)
E. Перечень файлов проекта/релизный состав (что отдаётся в производство)
F. История ревизий платы (Rev.A → Rev.B и т. п.)
G. Карта критичных сетей/сигналов (clock/reset/boot/ETH pairs/RS-485 A-B/DC-DC SW и т. п.)
H. Снимок правил проектирования (DRC/Altium Rules) и ключевые ограничения трассировки






### Правило хранения данных (строгий регламент)

#### Библиотека компонента (SchLib / PcbLib)
| Тип компонента | Default Designator | Default Comment | Description | User Params (Mfr/MPN/…) | Footprint model |
|---|---:|---:|---:|---:|---:|
| Пассивки (R/C/L/простые диоды) | ✅ | ❌ | ❌ | ❌ | ✅ |
| Уникальные ИС/MCU | ✅ | ❌ | ❌ | ❌ | ✅ |
| Разъёмы/клеммы | ✅ | ❌ | ❌ | ❌ | ✅ |
| Питание/модули/реле | ✅ | ❌ | ❌ | ❌ | ✅ |

#### Данные в проекте (SchDoc)
| Тип компонента | Comment | Description | Manufacturer | Manufacturer Part Number | BOM Description |
|---|---:|---:|---:|---:|---:|
| Пассивки (R/C/L/простые диоды) | ✅ | ❌ | ✅ | ✅ | ✅ |
| Уникальные ИС/MCU | ❌ | ❌ | ✅ | ✅ | ✅ |
| Разъёмы/клеммы | ❌ | ❌ | ✅ | ✅ | ✅ |
| Питание/модули/реле | ❌ | ❌ | ✅ | ✅ | ✅ |



## Примеры заполнения (эталоны)

### Пример 1 — Резистор (пассивка)
#### Библиотека компонента (SchLib / PcbLib)
| Поле | Значение |
|---|---|
| Default Designator | `R?` |
| Default Comment | *(пусто)* |
| Description | *(пусто)* |
| User Params (Mfr/MPN/…) | *(пусто)* |
| Footprint model | `RES_0603` *(пример)* |

#### Данные в проекте (SchDoc)
| Поле | Значение |
|---|---|
| Designator | `R24` *(пример)* |
| Comment | `240R` *(пример)* |
| Description | *(пусто)* |
| Manufacturer | `Yageo` *(пример)* |
| Manufacturer Part Number | `RC0603FR-07240RL` *(пример)* |
| BOM Description | `Resistor 240R 1% 0.1W 0603` *(пример)* |

---

### Пример 2 — МК SAM3X8E (уникальная ИС)
#### Библиотека компонента (SchLib / PcbLib)
| Поле | Значение |
|---|---|
| Default Designator | `U?` |
| Default Comment | *(пусто)* |
| Description | *(пусто)* |
| User Params (Mfr/MPN/…) | *(пусто)* |
| Footprint model | `LQFP144_20x20_0.5mm` *(пример)* |

#### Данные в проекте (SchDoc)
| Поле | Значение |
|---|---|
| Designator | `U1` *(пример)* |
| Comment | *(пусто)* |
| Description | *(пусто)* |
| Manufacturer | `Microchip` *(пример)* |
| Manufacturer Part Number | `ATSAM3X8EA-AU` *(пример)* |
| BOM Description | `MCU ATSAM3X8E, ARM Cortex-M3, LQFP144` *(пример)* |
